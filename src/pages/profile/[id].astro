---
import Layout from '../../layouts/Layout.astro';

// Import d·ªØ li·ªáu ng∆∞·ªùi d√πng ƒë·ªÉ Astro bi·∫øt tr∆∞·ªõc danh s√°ch `id` khi build static
import usersData from '../../../public/data/users.json';

// Astro y√™u c·∫ßu dynamic route ph·∫£i khai b√°o getStaticPaths() ƒë·ªÉ build tƒ©nh
export function getStaticPaths() {
  const members = (usersData && usersData.data) ? usersData.data : [];
  
  // Tr·∫£ v·ªÅ danh s√°ch ƒë∆∞·ªùng d·∫´n: /profile/9, /profile/10, ...
  return members.map((member: any) => ({
    params: { id: String(member.id) }
  }));
}
---

<Layout title="Chi ti·∫øt th√†nh vi√™n">
  <main class="min-h-screen aurora-bg py-12 px-4 relative">
    <!-- Aurora Atmospheric Layers -->
    <div class="absolute inset-0 aurora-layer-1 pointer-events-none"></div>
    <div class="absolute inset-0 aurora-layer-2 pointer-events-none"></div>
    
    <div class="max-w-5xl mx-auto relative z-10">
      <!-- Back Button -->
      <div class="mb-6">
        <a href="/" class="aurora-button inline-flex items-center gap-2">
          ‚Üê Quay l·∫°i
        </a>
      </div>

      <div id="loading" class="text-center py-12">
        <div class="aurora-card inline-block px-8 py-6 rounded-2xl">
          <p class="aurora-text text-xl font-bold">‚ú® ƒêang t·∫£i d·ªØ li·ªáu...</p>
        </div>
      </div>

      <!-- Profile Content -->
      <div id="profileContent" class="hidden space-y-6">
        <!-- Header Card -->
        <div class="aurora-card rounded-2xl p-8">
          <div class="text-center">
            <h1 class="text-5xl font-bold aurora-text mb-2" id="userName"></h1>
            <p class="text-lg text-gray-600 mb-4" id="userBio"></p>
            <div class="flex gap-3 justify-center flex-wrap" id="userMeta"></div>
          </div>
        </div>

        <!-- Challenge Selector -->
        <div id="challengeSelector" class="flex gap-3 flex-wrap justify-center mb-6">
          <!-- Will be populated by JavaScript -->
        </div>

        <!-- Stats Grid -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4" id="statsGrid">
        </div>

        <!-- Certificates Section -->
        <div class="aurora-card rounded-2xl p-6" id="certificatesSection">
          <h2 class="text-2xl font-bold aurora-text mb-6">üèÜ Ch·ª©ng ch·ªâ</h2>
          <div id="certificatesList" class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Certificates will be rendered here -->
          </div>
          <div id="noCertificates" class="hidden text-center py-8 text-gray-500">
            Ch∆∞a c√≥ ch·ª©ng ch·ªâ n√†o. H√£y ho√†n th√†nh c√°c th·ª≠ th√°ch ƒë·ªÉ nh·∫≠n ch·ª©ng ch·ªâ! üéØ
          </div>
        </div>

        <!-- Calendar History - Heatmap -->
        <div class="aurora-card rounded-2xl p-6">
          <h2 class="text-2xl font-bold aurora-text mb-6">üìÖ L·ªãch s·ª≠ Check-in</h2>
          <div class="mb-4 flex items-center gap-2 text-sm text-gray-600">
            <span>√çt</span>
            <div class="flex gap-1">
              <div class="w-4 h-4 rounded bg-gray-200"></div>
              <div class="w-4 h-4 rounded bg-green-200"></div>
              <div class="w-4 h-4 rounded bg-green-400"></div>
              <div class="w-4 h-4 rounded bg-green-600"></div>
              <div class="w-4 h-4 rounded bg-green-800"></div>
            </div>
            <span>Nhi·ªÅu</span>
          </div>
          <div id="calendar" class="space-y-8">
          </div>
        </div>

        <!-- Detailed History -->
        <div class="aurora-card rounded-2xl p-6">
          <h2 class="text-2xl font-bold aurora-text mb-6">üìä Chi ti·∫øt theo th√°ng</h2>
          <div id="monthlyStats"></div>
        </div>
      </div>
    </div>
  </main>
</Layout>

<script>
  import { calculateUserStats } from '../../utils/calculateStats.js';

  // L·∫•y userId t·ª´ URL nh∆∞ng ch·ªëng l·ªói d·∫•u "/" ·ªü cu·ªëi (Cloudflare th∆∞·ªùng redirect th√†nh /profile/9/)
  const pathParts = window.location.pathname.split('/').filter(Boolean);
  const userId = pathParts[pathParts.length - 1];

  // Challenge date ranges for certificate calculation (excludes grace period)
  const challengeDateRanges = {
    '1': { start: '2025-09-03', end: '2025-12-11' },
    '2': { start: '2025-12-22', end: '2026-03-31' },
    '3': { start: '2026-05-01', end: '2026-08-09' }
  };

  const challengeNames = {
    '1': 'Anki Challenge 8',
    '2': 'Anki Challenge 9',
    '3': 'Anki Challenge 10'
  };

  async function loadProfile() {
    try {
      const loadingDiv = document.getElementById('loading');
      const profileContent = document.getElementById('profileContent');

      // Load user data and study records (th√™m cache-busting ƒë·ªÉ CDN kh√¥ng cache data c≈©)
      const cacheBuster = '?v=' + Date.now();
      const [usersResponse, studyRecordsResponse] = await Promise.all([
        fetch('/data/users.json' + cacheBuster),
        fetch('/data/studyRecords.json' + cacheBuster)
      ]);

      const usersData = await usersResponse.json();
      const allRecords = await studyRecordsResponse.json();
      
      console.log('üì¶ [PROFILE] usersData:', usersData ? 'EXISTS' : 'NULL');
      
      if (!usersData || !usersData.data) {
        if (loadingDiv) loadingDiv.innerHTML = '<p class="text-red-500">D·ªØ li·ªáu ng∆∞·ªùi d√πng kh√¥ng h·ª£p l·ªá</p>';
        console.error('‚ùå [PROFILE] usersData or usersData.data is null/undefined');
        return;
      }
      
      const members = usersData.data || [];
      console.log('üë• [PROFILE] Found', members.length, 'members');
      
      const user = members.find(m => m.id.toString() === userId);

      if (!user) {
        if (loadingDiv) loadingDiv.innerHTML = '<p class="text-red-500">Kh√¥ng t√¨m th·∫•y th√†nh vi√™n</p>';
        return;
      }

      console.log('üìö [PROFILE] Study records loaded:', Object.keys(allRecords).length, 'dates');

      // Get user's challenges
      const challengeIds = user.challengeIds || ['1'];

      console.log('üéØ [PROFILE] Calculating stats for user:', user.name, 'ID:', userId);
      console.log('üéØ [PROFILE] Challenges:', challengeIds);

      // Calculate stats for each challenge using shared utility
      const challengeStats = [];
      console.log('üîÑ [PROFILE] Starting to process', challengeIds.length, 'challenges');
      
      for (const challengeId of challengeIds) {
        console.log(`\nüìä [PROFILE] Processing Challenge ${challengeId}...`);
        
        // Use the shared calculateUserStats function
        const usersWithStats = calculateUserStats([user], allRecords, challengeId, challengeDateRanges);
        console.log('üìä [PROFILE] calculateUserStats returned:', usersWithStats.length, 'results');
        
        if (usersWithStats.length > 0 && usersWithStats[0].currentStat) {
          const stat = usersWithStats[0].currentStat;
          challengeStats.push({
            challengeId: parseInt(challengeId),
            dates: stat.dates,
            streak: stat.streak,
            longestStreak: stat.longestStreak,
            totalDays: stat.totalDays,
            disciplinePercentage: stat.disciplinePercentage
          });
          
          console.log(`‚úÖ [PROFILE] Challenge ${challengeId} stats:`, {
            streak: stat.streak,
            longestStreak: stat.longestStreak,
            totalDays: stat.totalDays,
            discipline: stat.disciplinePercentage + '%',
            datesCount: stat.dates?.length || 0
          });
        } else {
          console.warn(`‚ö†Ô∏è [PROFILE] No stats returned for Challenge ${challengeId}`);
        }
      }
      
      console.log('‚úÖ [PROFILE] Total challenges with stats:', challengeStats.length);

      // Display profile
      displayProfile(user, challengeStats, allRecords);

      if (loadingDiv) loadingDiv.classList.add('hidden');
      if (profileContent) profileContent.classList.remove('hidden');

    } catch (error) {
      console.error('Error loading profile:', error);
      const loadingDiv = document.getElementById('loading');
      if (loadingDiv) {
        loadingDiv.innerHTML = `<p class="text-red-500">L·ªói: ${error.message}</p>`;
      }
    }
  }

  // Function removed - now using shared calculateUserStats from utils

  // Store current view state
  let currentUser = null;
  let allChallengeStats = [];
  let currentViewChallengeId = null;

  function displayProfile(user, challengeStats, allRecords) {
    currentUser = user;
    allChallengeStats = challengeStats;
    
    // Set current view to first challenge if not set
    if (!currentViewChallengeId && challengeStats.length > 0) {
      currentViewChallengeId = challengeStats[0].challengeId;
    }
    
    // Render challenge selector
    renderChallengeSelector(user, challengeStats);
    
    // User header
    const userNameEl = document.getElementById('userName');
    const userBioEl = document.getElementById('userBio');
    const userMetaEl = document.getElementById('userMeta');

    if (userNameEl) userNameEl.textContent = user.name;
    if (userBioEl) userBioEl.textContent = user.bio || 'Kh√¥ng c√≥ bio';
    if (userMetaEl) {
      userMetaEl.innerHTML = `
        ${user.learningLanguage ? `<span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm font-semibold">üåê ${user.learningLanguage}</span>` : ''}
        ${user.major ? `<span class="px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-sm font-semibold">üéì ${user.major}</span>` : ''}
        ${user.birthYear ? `<span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm font-semibold">üìÖ ${user.birthYear}</span>` : ''}
      `;
    }

    // Stats grid - show current selected challenge or first challenge
    updateStatsDisplay(challengeStats);

    // Display certificates
    displayCertificates(user, challengeStats);

    // Calendar view - display current challenge only
    const displayStats = currentViewChallengeId 
      ? challengeStats.filter(s => s.challengeId === currentViewChallengeId)
      : [challengeStats[0]];
    
    displayCalendars(displayStats);

    // Monthly breakdown
    displayMonthlyStats(displayStats);
  }

  function displayCertificates(user: any, challengeStats: any) {
    const certificatesListEl = document.getElementById('certificatesList');
    const noCertificatesEl = document.getElementById('noCertificates');
    
    if (!certificatesListEl) return;

    // Filter challenges that user has participated in and meet criteria
    // For now, show certificates for all challenges the user participated in
    const eligibleChallenges = challengeStats.filter((stat: any) => {
      // You can add criteria here, e.g., minimum attendance rate
      // return stat.disciplinePercentage >= 50; // At least 50% attendance
      return true; // Show all for now
    });

    if (eligibleChallenges.length === 0) {
      certificatesListEl.innerHTML = '';
      if (noCertificatesEl) noCertificatesEl.classList.remove('hidden');
      return;
    }

    if (noCertificatesEl) noCertificatesEl.classList.add('hidden');

    certificatesListEl.innerHTML = eligibleChallenges.map((stat: any) => {
      const challengeName = challengeNames[stat.challengeId] || 'Unknown Challenge';
      const dateRange = challengeDateRanges[stat.challengeId];
      const startDate = new Date(dateRange.start);
      const endDate = new Date(dateRange.end);
      const today = new Date();
      const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
      const effectiveEndDate = todayStr < dateRange.end ? todayStr : dateRange.end;
      const daysSoFar = Math.ceil((new Date(effectiveEndDate) - startDate) / (1000 * 60 * 60 * 24)) + 1;
      const disciplinePercentage = Math.round((stat.totalDays / daysSoFar) * 100);

      return `
        <div class="certificate-card" data-user-id="${user.id}" data-challenge-id="${stat.challengeId}">
          <div class="certificate-content">
            <div class="certificate-header">
              <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="certificate-icon">
                <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/>
              </svg>
              <h3 class="certificate-title">${challengeName}</h3>
            </div>
            <div class="certificate-stats">
              <div class="stat-item">
                <div class="stat-value">${stat.totalDays}<span class="stat-total">/${daysSoFar}</span></div>
                <div class="stat-label">Ng√†y h·ªçc</div>
              </div>
              <div class="stat-divider"></div>
              <div class="stat-item">
                <div class="stat-value">${disciplinePercentage}<span class="stat-unit">%</span></div>
                <div class="stat-label">K·ª∑ lu·∫≠t</div>
              </div>
            </div>
          </div>
          
          <div class="certificate-actions">
            <button class="btn-download" onclick="downloadCertificate(${user.id}, ${stat.challengeId}, 'html')">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="7 10 12 15 17 10"/>
                <line x1="12" y1="15" x2="12" y2="3"/>
              </svg>
              T·∫£i ch·ª©ng ch·ªâ
            </button>
          </div>
        </div>
      `;
    }).join('');
  }

  // Function to download certificate - t√≠nh to√°n t·ª´ JSON files thay v√¨ g·ªçi API
  (window as any).downloadCertificate = async function(userId: any, challengeId: any, format: any) {
    try {
      // Fetch data t·ª´ JSON files (th√™m cache-busting)
      const cb = '?v=' + Date.now();
      const [usersRes, challengesRes, recordsRes] = await Promise.all([
        fetch('/data/users.json' + cb),
        fetch('/data/challenges.json' + cb),
        fetch('/data/studyRecords.json' + cb)
      ]);

      if (!usersRes.ok || !challengesRes.ok || !recordsRes.ok) {
        throw new Error('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu');
      }

      const usersData = await usersRes.json();
      const challengesData = await challengesRes.json();
      const studyRecordsData = await recordsRes.json();

      // T√¨m user
      const user = usersData.data.find((u: any) => u.id === parseInt(userId));
      if (!user) throw new Error('Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng');

      // T√¨m challenge
      const challenge = challengesData[challengeId];
      if (!challenge) throw new Error('Kh√¥ng t√¨m th·∫•y challenge');

      // T√≠nh to√°n stats
      const startDate = new Date(challenge.start);
      const endDate = new Date(challenge.end);
      
      let totalDays = 0;
      let studyDays = 0;
      
      for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
        totalDays++;
        const dateStr = d.toISOString().split('T')[0];
        if (studyRecordsData[dateStr] && studyRecordsData[dateStr][userId]) {
          studyDays++;
        }
      }

      const attendanceRate = totalDays > 0 ? Math.round((studyDays / totalDays) * 100) : 0;
      
      const today = new Date();
      const completionDate = endDate < today ? endDate : today;
      const formattedDate = completionDate.toLocaleDateString('vi-VN', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
      });

      const data = {
        userName: user.name,
        challengeName: challenge.name,
        studyDays,
        totalDays,
        attendanceRate,
        completionDate: formattedDate
      };
      
      if (format === 'html') {
        // Generate full HTML
        const htmlContent = generateCertificateHTML(data);
        const blob = new Blob([htmlContent], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `certificate_${data.userName.replace(/\s/g, '_')}_${data.challengeName.replace(/\s/g, '_')}.html`;
        a.click();
        URL.revokeObjectURL(url);
      }
    } catch (error) {
      console.error('Error downloading certificate:', error);
      alert('Kh√¥ng th·ªÉ t·∫£i ch·ª©ng ch·ªâ. Vui l√≤ng th·ª≠ l·∫°i sau.');
    }
  };

  function generateCertificateHTML(data: any) {
    return `<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Certificate - ${data.userName} - ${data.challengeName}</title>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@300;400;500;700;900&family=Playfair+Display:ital,wght@0,700;1,700&family=Mrs+Saint+Delafield&display=swap');
      
      @page {
        size: A4 portrait;
        margin: 0;
      }

      * { box-sizing: border-box; }

      html, body {
        margin: 0; padding: 0;
        width: 100%; height: 100%;
        background-color: #e2e8f0;
      }

      body {
        font-family: 'Be Vietnam Pro', sans-serif;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .container {
        width: 210mm;
        height: 297mm;
        background-color: #ffffff;
        position: relative;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 20mm;
        box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        overflow: hidden;
      }

      .container::before {
        content: '';
        position: absolute;
        top: 10mm; left: 10mm; right: 10mm; bottom: 10mm;
        border: 2px solid #1e293b;
        z-index: 1;
        pointer-events: none;
      }
      
      .container::after {
        content: '';
        position: absolute;
        top: 12mm; left: 12mm; right: 12mm; bottom: 12mm;
        border: 1px solid #d97706;
        z-index: 1;
        pointer-events: none;
      }

      .corner-decor {
        position: absolute;
        width: 40mm; height: 40mm;
        border: 4px double #d97706;
        z-index: 2;
      }
      .top-left { top: 10mm; left: 10mm; border-right: none; border-bottom: none; }
      .top-right { top: 10mm; right: 10mm; border-left: none; border-bottom: none; }
      .bottom-left { bottom: 10mm; left: 10mm; border-right: none; border-top: none; }
      .bottom-right { bottom: 10mm; right: 10mm; border-left: none; border-top: none; }
      
      .header {
        font-size: 13px; font-weight: 700; color: #b45309;
        letter-spacing: 5px; text-transform: uppercase; margin-bottom: 5mm;
        font-family: 'Be Vietnam Pro', sans-serif;
        z-index: 3;
      }

      h1 {
        font-family: 'Playfair Display', serif;
        font-size: 40pt; font-weight: 700; 
        color: #0f172a;
        margin: 0 0 10mm 0; line-height: 1.1; text-align: center;
        z-index: 3;
      }

      .presented-to {
        font-size: 13pt; margin-bottom: 4mm; color: #64748b;
        font-style: italic; font-weight: 400;
        z-index: 3;
      }

      .user-name {
        font-family: 'Playfair Display', serif;
        font-size: 44pt; font-weight: 900; 
        color: #1e3a8a;
        margin: 0 0 5mm 0; 
        border-bottom: 2px solid #d97706;
        padding-bottom: 3mm; display: inline-block; line-height: 1.2;
        z-index: 3;
      }

      .description {
        font-size: 14pt; color: #334155; margin-top: 5mm; font-weight: 300;
        z-index: 3;
      }

      .challenge-name {
        font-size: 36pt; 
        font-weight: 900; 
        text-transform: uppercase;
        margin: 5mm 0 15mm 0;
        letter-spacing: 3px;
        background: linear-gradient(90deg, #1e3a8a 0%, #0891b2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        filter: drop-shadow(0px 2px 0px rgba(0,0,0,0.1));
        z-index: 3;
      }

      .overview {
        display: flex; justify-content: center; gap: 20mm;
        width: 100%; margin-bottom: 15mm;
        z-index: 3;
      }

      .stat-item {
        display: flex; flex-direction: column; align-items: center;
        padding: 0;
        min-width: 40mm;
      }

      .icon-wrapper { 
        margin-bottom: 2mm; 
        color: #d97706; 
      }
      
      .stat-value { 
        font-size: 24pt; font-weight: 800; 
        color: #0f172a;
        margin-bottom: 0mm; 
        font-family: 'Be Vietnam Pro', sans-serif;
      }
      
      .stat-label { 
        font-size: 9pt; color: #64748b; 
        font-weight: 600; text-transform: uppercase; letter-spacing: 1px;
        margin-top: 2mm;
        border-top: 1px solid #e2e8f0;
        padding-top: 2mm;
        width: 100%; text-align: center;
      }

      .footer {
        display: flex; justify-content: space-between;
        width: 75%;
        margin-top: 15mm; align-items: flex-end;
        z-index: 3;
      }

      .footer-col {
        text-align: center; width: 60mm; position: relative;
        display: flex; flex-direction: column; justify-content: flex-end;
      }

      .signature-title {
        font-size: 9pt; font-weight: 700; color: #94a3b8;
        text-transform: uppercase; letter-spacing: 2px;
      }

      .col-date .signature-title { margin-bottom: 8mm; }
      .col-org .signature-title { margin-bottom: 35mm; }

      .signature-line {
        border-top: 1px solid #cbd5e1;
        margin-bottom: 3mm; width: 100%;
      }
      
      .signature-content {
        font-size: 12pt; font-weight: 600; color: #334155;
        font-family: 'Be Vietnam Pro', sans-serif;
      }

      .signed-hph {
        font-family: 'Mrs Saint Delafield', cursive;
        font-size: 55pt; 
        color: #1e3a8a;
        position: absolute; bottom: 12mm; left: 0; right: 0;
        transform: rotate(-8deg); 
        z-index: 10; line-height: 1; pointer-events: none;
        opacity: 0.9;
      }

      .website-footer {
        position: absolute; bottom: 14mm; left: 0; right: 0;
        text-align: center; font-size: 9pt; 
        color: #cbd5e1;
        font-weight: 400; letter-spacing: 3px;
        font-family: 'Be Vietnam Pro', sans-serif;
        text-transform: lowercase;
        z-index: 3;
      }

      @media print {
        body { background-color: #fff; display: block; }
        .container {
          width: 210mm; height: 296mm; 
          box-shadow: none; margin: 0; padding: 20mm;
          page-break-after: avoid; overflow: hidden;
        }
        .challenge-name {
          background: none;
          -webkit-text-fill-color: #1e3a8a; 
          color: #1e3a8a;
        }
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
    </style>
</head>
<body>
    <div class="container">
        <div class="corner-decor top-left"></div>
        <div class="corner-decor top-right"></div>
        <div class="corner-decor bottom-left"></div>
        <div class="corner-decor bottom-right"></div>

        <div class="header">GI·∫§Y CH·ª®NG NH·∫¨N</div>
        <h1>Certificate of<br>Achievement</h1>
        
        <div class="presented-to">Tr√¢n tr·ªçng trao t·∫∑ng cho</div>
        <div class="user-name">${data.userName.toUpperCase()}</div>
        
        <div class="description">ƒê√£ n·ªó l·ª±c v√† ho√†n th√†nh xu·∫•t s·∫Øc th·ª≠ th√°ch</div>
        
        <div class="challenge-name">${data.challengeName.toUpperCase()}</div>

        <div class="overview">
            <div class="stat-item">
                <div class="icon-wrapper">
                    <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                </div>
                <div class="stat-value">${data.studyDays}/${data.totalDays}</div>
                <div class="stat-label">Ng√†y h·ªçc</div>
            </div>
            
            <div class="stat-item">
                <div class="icon-wrapper">
                    <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="6"></circle><circle cx="12" cy="12" r="2"></circle></svg>
                </div>
                <div class="stat-value">${data.attendanceRate}%</div>
                <div class="stat-label">K·ª∑ lu·∫≠t</div>
            </div>
        </div>

        <div class="footer">
            <div class="footer-col col-date">
                <div class="signature-title">Ng√†y c·∫•p</div>
                <div class="signature-line"></div>
                <div class="signature-content">${data.completionDate}</div>
            </div>

            <div class="footer-col col-org">
                <div class="signature-title">Ban t·ªï ch·ª©c</div>
                <div class="signed-hph">Hph</div>
                <div class="signature-line"></div>
                <div class="signature-content" style="color: #1e3a8a;">Anki Vi·ªát Nam</div>
            </div>
        </div>

        <div class="website-footer">ankivn.com</div>
    </div>
</body>
</html>`;
  }

  function displayCalendars(challengeStats) {
    const calendarEl = document.getElementById('calendar');
    if (!calendarEl) {
      console.warn('‚ö†Ô∏è [PROFILE] calendar element not found');
      return;
    }

    console.log('üìÖ [PROFILE] Rendering calendars for', challengeStats.length, 'challenges');

    if (!challengeStats || challengeStats.length === 0) {
      console.warn('‚ö†Ô∏è [PROFILE] No challenge stats to display');
      calendarEl.innerHTML = '<p class="text-gray-500 text-center py-8">Kh√¥ng c√≥ d·ªØ li·ªáu th·ªëng k√™</p>';
      return;
    }

    const html = challengeStats.map(stat => {
      if (!stat) {
        console.warn('‚ö†Ô∏è [PROFILE] Null stat object');
        return '';
      }
      console.log('üìÖ [PROFILE] Challenge', stat.challengeId, 'has', stat.dates?.length || 0, 'dates');
      
      const challengeName = challengeNames[stat.challengeId] || 'Unknown Challenge';
      const dateRange = challengeDateRanges[stat.challengeId];
      const startDate = new Date(dateRange.start);
      const endDate = new Date(dateRange.end);
      const today = new Date();
      const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
      const effectiveEndDate = todayStr < dateRange.end ? todayStr : dateRange.end;
      const daysSoFar = Math.ceil((new Date(effectiveEndDate) - startDate) / (1000 * 60 * 60 * 24)) + 1;
      const totalChallengeDays = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
      const disciplinePercentage = Math.round((stat.totalDays / daysSoFar) * 100);
      
      // Make sure stat.dates exists
      const checkedDates = stat.dates || [];
      
      // Generate all days in the challenge period
      const allDays = [];
      for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
        const dateStr = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
        // Calculate day number (Day 1 = start date)
        const daysDiff = Math.floor((d - startDate) / (1000 * 60 * 60 * 24));
        const dayNumber = daysDiff + 1;
        
        const isChecked = checkedDates.includes(dateStr);
        const monthYear = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
        
        allDays.push({
          dayNumber,
          dateStr,
          displayDate: `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth() + 1).padStart(2, '0')}`,
          isChecked,
          monthYear
        });
      }
      
      // Group by month
      const daysByMonth = {};
      allDays.forEach(day => {
        if (!daysByMonth[day.monthYear]) {
          daysByMonth[day.monthYear] = [];
        }
        daysByMonth[day.monthYear].push(day);
      });
      
      return `
        <div class="border-t border-gray-200 first:border-t-0 pt-6 first:pt-0">
          <h3 class="text-xl font-bold text-gray-800 mb-2">${challengeName}</h3>
          <p class="text-sm text-gray-600 mb-4">${dateRange.start} - ${dateRange.end} (${stat.totalDays}/${daysSoFar} ng√†y, ${disciplinePercentage}% k·ª∑ lu·∫≠t)</p>
          
          <div class="space-y-6">
            ${Object.entries(daysByMonth).map(([monthKey, days]) => {
              const firstDay = days[0];
              const monthDate = new Date(firstDay.dateStr);
              const monthName = monthDate.toLocaleDateString('vi-VN', { year: 'numeric', month: 'long' });
              const checkedInMonth = days.filter(d => d.isChecked).length;
              const totalInMonth = days.length;
              const monthPercent = Math.round((checkedInMonth / totalInMonth) * 100);
              
              return `
                <div>
                  <div class="flex items-center justify-between mb-3">
                    <h4 class="font-semibold text-gray-700">${monthName}</h4>
                    <span class="text-xs text-gray-600">${checkedInMonth}/${totalInMonth} ng√†y (${monthPercent}%)</span>
                  </div>
                  <div class="grid grid-cols-7 sm:grid-cols-10 md:grid-cols-14 gap-2">
                    ${days.map(day => `
                      <div class="flex items-center justify-center aspect-square rounded text-xs font-medium ${
                        day.isChecked 
                          ? 'bg-green-500 text-white' 
                          : 'bg-red-500 text-white'
                      }" title="Day ${day.dayNumber}: ${day.displayDate}">
                        <div class="text-center">
                          <div class="text-[10px] leading-tight">D${day.dayNumber}</div>
                          <div class="text-[9px] leading-tight opacity-80">${day.displayDate}</div>
                        </div>
                      </div>
                    `).join('')}
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;
    }).join('');

    calendarEl.innerHTML = html;
  }

  // Render challenge selector buttons
  function renderChallengeSelector(user, challengeStats) {
    const selectorEl = document.getElementById('challengeSelector');
    if (!selectorEl) return;

    if (challengeStats.length === 0) {
      selectorEl.innerHTML = '<p class="text-gray-500 text-sm">Ch∆∞a tham gia challenge n√†o</p>';
      return;
    }

    const html = challengeStats.map(stat => {
      const challengeName = challengeNames[stat.challengeId] || `Challenge ${stat.challengeId}`;
      const isActive = currentViewChallengeId === stat.challengeId;
      const activeClass = isActive 
        ? 'bg-gradient-to-r from-blue-500 to-purple-600 text-white shadow-lg' 
        : 'bg-white text-gray-700 hover:bg-gray-50';
      
      return `
        <button 
          class="px-6 py-3 rounded-xl font-semibold transition-all ${activeClass} challenge-btn"
          data-challenge-id="${stat.challengeId}"
        >
          ${challengeName}
          <span class="text-xs opacity-80 ml-2">(${stat.totalDays} ng√†y)</span>
        </button>
      `;
    }).join('');

    selectorEl.innerHTML = html;

    // Add click handlers
    document.querySelectorAll('.challenge-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const challengeId = parseInt(btn.getAttribute('data-challenge-id'));
        switchChallenge(challengeId);
      });
    });
  }

  function switchChallenge(challengeId) {
    currentViewChallengeId = challengeId;
    const stat = allChallengeStats.find(s => s.challengeId === challengeId);
    
    if (!stat) {
      console.warn('‚ö†Ô∏è [PROFILE] Challenge not found:', challengeId);
      return;
    }

    console.log('üîÑ [PROFILE] Switching to Challenge', challengeId);
    
    // Re-render with selected challenge
    renderChallengeSelector(currentUser, allChallengeStats);
    updateStatsDisplay([stat]);
    displayCalendars([stat]);
    displayMonthlyStats([stat]);
  }

  function updateStatsDisplay(challengeStats) {
    const statsGridEl = document.getElementById('statsGrid');
    if (statsGridEl && challengeStats.length > 0) {
      const mainStats = challengeStats[0];
      statsGridEl.innerHTML = `
        <div class="aurora-card rounded-xl p-6 text-center">
          <div class="text-4xl mb-2">üî•</div>
          <div class="text-3xl font-bold aurora-text">${mainStats.streak}</div>
          <div class="text-sm text-gray-600 mt-1">Chu·ªói hi·ªán t·∫°i</div>
        </div>
        <div class="aurora-card rounded-xl p-6 text-center">
          <div class="text-4xl mb-2">üèÜ</div>
          <div class="text-3xl font-bold aurora-text">${mainStats.longestStreak}</div>
          <div class="text-sm text-gray-600 mt-1">K·ª∑ l·ª•c</div>
        </div>
        <div class="aurora-card rounded-xl p-6 text-center">
          <div class="text-4xl mb-2">üìÖ</div>
          <div class="text-3xl font-bold aurora-text">${mainStats.totalDays}</div>
          <div class="text-sm text-gray-600 mt-1">T·ªïng ng√†y</div>
        </div>
        <div class="aurora-card rounded-xl p-6 text-center">
          <div class="text-4xl mb-2">üí™</div>
          <div class="text-3xl font-bold aurora-text">${mainStats.disciplinePercentage}%</div>
          <div class="text-sm text-gray-600 mt-1">K·ª∑ lu·∫≠t</div>
        </div>
      `;
    }
  }

  // Removed generateHeatmap - using list view instead
  
  function _removedGenerateHeatmap() {
    return; // Function removed
    const dateRange = {};
    const startDate = new Date();
    const endDate = new Date();

    // Calculate streak for each date for intensity
    const dateStreaks = new Map();
    const sortedDates = [...dates].sort();
    
    let currentStreak = 0;
    for (let i = 0; i < sortedDates.length; i++) {
      if (i === 0) {
        currentStreak = 1;
      } else {
        const prevDate = new Date(sortedDates[i - 1]);
        const currDate = new Date(sortedDates[i]);
        const diffDays = Math.floor((currDate - prevDate) / (1000 * 60 * 60 * 24));
        
        if (diffDays === 1) {
          currentStreak++;
        } else {
          currentStreak = 1;
        }
      }
      dateStreaks.set(sortedDates[i], currentStreak);
    }

    // Get max streak for color scaling
    const maxStreak = Math.max(...Array.from(dateStreaks.values()), 1);

    // Build heatmap by weeks
    const allDates = [];
    for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
      allDates.push(new Date(d));
    }

    // Group by weeks
    const weeks = [];
    let currentWeek = [];
    
    // Start from Sunday of the first week
    const firstDate = allDates[0];
    const firstDayOfWeek = firstDate.getDay();
    
    // Add empty cells for days before start
    for (let i = 0; i < firstDayOfWeek; i++) {
      currentWeek.push(null);
    }

    allDates.forEach(date => {
      const dayOfWeek = date.getDay();
      
      if (dayOfWeek === 0 && currentWeek.length > 0) {
        weeks.push(currentWeek);
        currentWeek = [];
      }
      
      currentWeek.push(date);
    });
    
    if (currentWeek.length > 0) {
      weeks.push(currentWeek);
    }

    // Generate heatmap HTML
    const monthLabels = [];
    let lastMonth = -1;
    let weekIndex = 0;

    weeks.forEach((week, idx) => {
      const firstValidDate = week.find(d => d !== null);
      if (firstValidDate) {
        const month = firstValidDate.getMonth();
        if (month !== lastMonth) {
          monthLabels.push({
            month: firstValidDate.toLocaleDateString('vi-VN', { month: 'short' }),
            weekIndex: idx
          });
          lastMonth = month;
        }
      }
    });

    // Days of week labels
    const daysOfWeek = ['CN', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7'];
    
    const heatmapHTML = `
      <div class="flex gap-1">
        <!-- Day labels -->
        <div class="flex flex-col justify-around text-xs text-gray-600 pr-2">
          ${daysOfWeek.map((day, i) => i % 2 === 1 ? `<div class="h-3">${day}</div>` : '<div class="h-3"></div>').join('')}
        </div>
        
        <!-- Month labels -->
        <div class="flex-1">
          <div class="flex gap-1 mb-1 text-xs text-gray-600" style="padding-left: ${weeks.length > 0 ? '0' : '0'}">
            ${monthLabels.map(ml => `<div style="width: ${14 * 7}px">${ml.month}</div>`).join('')}
          </div>
          
          <!-- Heatmap grid -->
          <div class="flex gap-1">
            ${weeks.map(week => `
              <div class="flex flex-col gap-1">
                ${week.map(date => {
                  if (!date) {
                    return '<div class="w-3 h-3"></div>';
                  }
                  
                  const dateStr = date.toISOString().split('T')[0];
                  const isChecked = dates.includes(dateStr);
                  const streak = dateStreaks.get(dateStr) || 0;
                  
                  // Calculate color intensity based on streak
                  let colorClass = 'bg-gray-200';
                  if (isChecked) {
                    const intensity = Math.min(Math.floor((streak / maxStreak) * 4) + 1, 4);
                    const colors = [
                      'bg-green-200',
                      'bg-green-400',
                      'bg-green-600',
                      'bg-green-800'
                    ];
                    colorClass = colors[intensity - 1];
                  }
                  
                  const dayNum = date.getDate();
                  const monthName = date.toLocaleDateString('vi-VN', { month: 'short', day: 'numeric' });
                  
                  return `
                    <div class="w-3 h-3 rounded-sm ${colorClass} cursor-pointer hover:ring-2 hover:ring-blue-400 transition-all" 
                         title="${monthName}: ${isChecked ? `‚úÖ Check-in (Chu·ªói: ${streak})` : 'Ch∆∞a check-in'}"
                         data-date="${dateStr}">
                    </div>
                  `;
                }).join('')}
              </div>
            `).join('')}
          </div>
        </div>
      </div>
    `;

    return heatmapHTML;
  }

  function displayMonthlyStats(challengeStats) {
    const monthlyStatsEl = document.getElementById('monthlyStats');
    if (!monthlyStatsEl) {
      console.warn('‚ö†Ô∏è [PROFILE] monthlyStats element not found');
      return;
    }

    console.log('üìä [PROFILE] Displaying monthly stats for', challengeStats.length, 'challenges');

    if (!challengeStats || challengeStats.length === 0) {
      monthlyStatsEl.innerHTML = '<p class="text-gray-500 text-center py-8">Ch∆∞a c√≥ d·ªØ li·ªáu th·ªëng k√™ theo th√°ng</p>';
      return;
    }

    const html = challengeStats.map(stat => {
      if (!stat || !stat.dates) {
        console.warn('‚ö†Ô∏è [PROFILE] Invalid stat object:', stat);
        return '';
      }

      const challengeName = challengeNames[stat.challengeId] || 'Unknown';
      const dateRange = challengeDateRanges[stat.challengeId];
      
      // Group by month
      const monthlyData = {};
      stat.dates.forEach(dateStr => {
        const month = dateStr.substring(0, 7); // YYYY-MM
        monthlyData[month] = (monthlyData[month] || 0) + 1;
      });

      const monthsHTML = Object.keys(monthlyData).sort().map(month => {
        const count = monthlyData[month];
        const monthName = new Date(month + '-01').toLocaleDateString('vi-VN', { year: 'numeric', month: 'long' });
        return `
          <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
            <span class="font-semibold text-gray-700">${monthName}</span>
            <span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full font-bold">${count} ng√†y</span>
          </div>
        `;
      }).join('');

      return `
        <div class="mb-6">
          <h3 class="text-xl font-bold text-gray-800 mb-3">${challengeName}</h3>
          <p class="text-sm text-gray-600 mb-4">${dateRange.start} - ${dateRange.end}</p>
          <div class="space-y-2">
            ${monthsHTML || '<p class="text-gray-500">Ch∆∞a c√≥ d·ªØ li·ªáu</p>'}
          </div>
        </div>
      `;
    }).join('');

    monthlyStatsEl.innerHTML = html;
  }

  // Load profile on page load
  loadProfile();
</script>

<style>
  .certificate-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    transition: all 0.3s ease;
    border: 1px solid rgba(0, 0, 0, 0.06);
  }

  .certificate-card:hover {
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
    border-color: rgba(102, 126, 234, 0.3);
  }

  .certificate-content {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .certificate-header {
    display: flex;
    align-items: center;
    gap: 12px;
    padding-bottom: 12px;
    border-bottom: 1px solid rgba(0, 0, 0, 0.08);
  }

  .certificate-icon {
    color: #fbbf24;
    flex-shrink: 0;
  }

  .certificate-title {
    font-size: 18px;
    font-weight: 600;
    margin: 0;
    color: #1e293b;
    line-height: 1.3;
  }

  .certificate-stats {
    display: flex;
    align-items: center;
    justify-content: space-around;
    gap: 16px;
  }

  .stat-item {
    flex: 1;
    text-align: center;
  }

  .stat-value {
    font-size: 28px;
    font-weight: 700;
    color: #667eea;
    line-height: 1;
    margin-bottom: 4px;
  }

  .stat-total,
  .stat-unit {
    font-size: 18px;
    font-weight: 600;
    color: #94a3b8;
  }

  .stat-label {
    font-size: 13px;
    color: #64748b;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .stat-divider {
    width: 1px;
    height: 40px;
    background: linear-gradient(to bottom, transparent, rgba(0, 0, 0, 0.1), transparent);
  }

  .certificate-actions {
    padding-top: 12px;
    border-top: 1px solid rgba(0, 0, 0, 0.08);
  }

  .btn-download {
    width: 100%;
    padding: 12px 20px;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    font-size: 15px;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
  }

  .btn-download:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
  }

  .btn-download:active {
    transform: translateY(0);
  }

  @media (max-width: 640px) {
    .certificate-card {
      padding: 16px;
    }

    .certificate-title {
      font-size: 16px;
    }

    .stat-value {
      font-size: 24px;
    }

    .stat-total,
    .stat-unit {
      font-size: 16px;
    }

    .stat-label {
      font-size: 11px;
    }

    .btn-download {
      padding: 10px 16px;
      font-size: 14px;
    }

    .btn-download svg {
      width: 18px;
      height: 18px;
    }
  }
</style>
</Layout>
