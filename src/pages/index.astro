---
import Layout from "../layouts/Layout.astro";
import ProgressBar from "../components/ProgressBar.astro";
---

<Layout title="Anki Challenge - B·∫£ng x·∫øp h·∫°ng">
	<main
		class="min-h-screen bg-slate-50 text-slate-900 relative overflow-hidden font-sans selection:bg-cyan-500/30"
	>
		<!-- Light Aurora/Mesh Gradient Background (Vibrant) -->
		<div class="fixed inset-0 z-0 pointer-events-none opacity-80">
			<div
				class="absolute top-[-20%] left-[-20%] w-[70%] h-[70%] rounded-full bg-gradient-to-r from-cyan-300/40 to-blue-300/40 blur-[120px] animate-pulse-slow"
			>
			</div>
			<div
				class="absolute bottom-[-20%] right-[-20%] w-[70%] h-[70%] rounded-full bg-gradient-to-l from-orange-200/50 to-amber-200/50 blur-[120px] animate-pulse-slow"
				style="animation-delay: 2s"
			>
			</div>
			<div
				class="absolute top-[30%] left-[50%] transform -translate-x-1/2 w-[60%] h-[60%] rounded-full bg-gradient-to-b from-purple-200/40 to-pink-200/40 blur-[140px] animate-pulse-slow"
				style="animation-delay: 4s"
			>
			</div>
		</div>

		<div class="max-w-6xl mx-auto px-4 py-8 md:py-12 relative z-10">
			<!-- Hero Section -->
			<div class="text-center mb-10 md:mb-16 space-y-5">
				<h1
					class="text-6xl md:text-8xl font-black tracking-tighter text-transparent bg-clip-text bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 drop-shadow-sm pb-2"
				>
					Leaderboard
				</h1>

				<div class="flex flex-col items-center justify-center gap-3">
					<div class="relative group">
						<select
							id="challengeSelect"
							class="appearance-none bg-white/70 border-2 border-slate-200 text-slate-900 text-xl md:text-2xl font-bold py-3 pl-8 pr-14 rounded-2xl backdrop-blur-xl focus:outline-none focus:ring-4 focus:ring-cyan-500/20 hover:bg-white/90 focus:border-cyan-500 transition-all cursor-pointer shadow-lg shadow-slate-200/50 tracking-tight"
						>
							<option value="1" class="text-slate-600"
								>Anki Challenge 8</option
							>
							<option
								value="2"
								selected
								class="text-slate-900 font-bold"
								>Anki Challenge 9</option
							>
							<option value="3" class="text-slate-600"
								>Anki Challenge 10</option
							>
						</select>
						<div
							class="absolute right-4 top-1/2 transform -translate-y-1/2 pointer-events-none text-slate-600"
						>
							<svg
								xmlns="http://www.w3.org/2000/svg"
								class="h-6 w-6"
								fill="none"
								viewBox="0 0 24 24"
								stroke="currentColor"
								stroke-width="2.5"
							>
								<path
									stroke-linecap="round"
									stroke-linejoin="round"
									d="M19 9l-7 7-7-7"></path>
							</svg>
						</div>
					</div>
					<p
						class="text-slate-500 font-bold tracking-widest uppercase text-xs md:text-sm"
						id="challengeTitle"
					>
						100 ng√†y th·ª≠ th√°ch
					</p>
				</div>
			</div>

			<!-- Progress Bar (Clean - Removed Inner Wrapper) -->
			<div
				class="mb-10 transform hover:scale-[1.01] transition-transform duration-500"
			>
				<ProgressBar challengeId="2" />
			</div>

			<!-- Controls Bar -->
			<div
				class="sticky top-4 z-50 mb-10 backdrop-blur-xl bg-white/90 rounded-[2rem] border border-white/60 shadow-2xl shadow-indigo-100/30 p-4 transition-all duration-300"
			>
				<div
					class="flex flex-col md:flex-row items-center gap-4 justify-between"
				>
					<!-- Search -->
					<div class="relative w-full md:max-w-md group">
						<div
							class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none"
						>
							<svg
								class="h-5 w-5 text-slate-400 group-focus-within:text-cyan-600 transition-colors"
								fill="none"
								viewBox="0 0 24 24"
								stroke="currentColor"
								stroke-width="2.5"
							>
								<path
									stroke-linecap="round"
									stroke-linejoin="round"
									d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
								></path>
							</svg>
						</div>
						<input
							type="text"
							id="searchInput"
							class="block w-full pl-11 pr-10 py-3.5 bg-slate-50 border-2 border-slate-100 rounded-2xl text-slate-900 placeholder-slate-400 focus:outline-none focus:ring-4 focus:ring-cyan-500/10 focus:border-cyan-500 transition-all font-bold shadow-inner"
							placeholder="T√¨m ki·∫øm th√†nh vi√™n..."
						/>
						<button
							id="clearSearch"
							class="absolute inset-y-0 right-0 pr-3 flex items-center hidden text-slate-400 hover:text-slate-600 transition-colors"
						>
							<svg
								class="h-5 w-5"
								fill="none"
								viewBox="0 0 24 24"
								stroke="currentColor"
								stroke-width="2.5"
							>
								<path
									stroke-linecap="round"
									stroke-linejoin="round"
									d="M6 18L18 6M6 6l12 12"></path>
							</svg>
						</button>
					</div>

					<!-- Toggle Display Mode (Real Switch) -->
					<div
						class="flex items-center gap-4 bg-slate-50 p-3 rounded-2xl border border-slate-100"
					>
						<span
							class="text-sm font-bold text-slate-500 uppercase tracking-wider"
							>Hi·ªÉn th·ªã</span
						>
						<label
							for="displayModeToggle"
							class="relative inline-flex items-center cursor-pointer"
						>
							<input
								type="checkbox"
								id="displayModeToggle"
								class="sr-only peer"
							/>
							<div
								class="w-14 h-8 bg-slate-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-cyan-300 dark:peer-focus:ring-cyan-800 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[4px] after:left-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-cyan-600 after:shadow-sm"
							>
							</div>
							<span
								class="ml-3 text-sm font-bold text-slate-700 w-20 text-center select-none"
								id="toggleLabel">Discord</span
							>
						</label>
					</div>
				</div>
			</div>

			<!-- Loading State -->
			<div id="loading" class="text-center py-24">
				<div
					class="inline-flex items-center gap-4 px-8 py-5 rounded-3xl bg-white/80 border border-white shadow-xl backdrop-blur-md"
				>
					<div class="relative w-7 h-7">
						<div
							class="absolute inset-0 rounded-full border-4 border-slate-100"
						>
						</div>
						<div
							class="absolute inset-0 rounded-full border-4 border-cyan-600 border-t-transparent animate-spin"
						>
						</div>
					</div>
					<span class="text-lg font-bold text-slate-700"
						>ƒêang t·∫£i d·ªØ li·ªáu...</span
					>
				</div>
			</div>

			<!-- Board Content -->
			<div
				id="leaderboard"
				class="hidden animate-fade-in-up group show-discord"
			>
				<!-- Mobile Cards -->
				<div class="md:hidden space-y-4" id="leaderboardCards">
					<div id="leaderboardCardsBody" class="space-y-4"></div>
				</div>

				<!-- Desktop Table -->
				<div
					class="hidden md:block overflow-hidden rounded-[2.5rem] border border-white/60 bg-white/70 backdrop-blur-2xl shadow-2xl shadow-indigo-100/40 ring-1 ring-white/60"
				>
					<table class="w-full text-left border-collapse">
						<thead
							class="bg-white/80 text-xs uppercase tracking-wider text-slate-500 border-b-2 border-slate-100 backdrop-blur-sm sticky top-0 z-10 w-full"
						>
							<tr>
								<th class="px-8 py-6 font-black text-slate-400"
									>H·∫°ng</th
								>
								<th class="px-8 py-6 font-black text-slate-400"
									>Th√†nh vi√™n</th
								>
								<th
									class="px-8 py-6 font-black text-center text-slate-400"
									>Chu·ªói</th
								>
								<th
									class="px-8 py-6 font-black text-center text-slate-400"
									>K·ª∑ l·ª•c</th
								>
								<th
									class="px-8 py-6 font-black text-center text-slate-400"
									>T·ªïng ng√†y</th
								>
								<th
									class="px-8 py-6 font-black text-center text-slate-400"
									>K·ª∑ lu·∫≠t</th
								>
							</tr>
						</thead>
						<tbody
							id="leaderboardBody"
							class="divide-y divide-slate-100 text-sm font-medium text-slate-700"
						>
							<!-- Rows injected here -->
						</tbody>
					</table>
				</div>
			</div>

			<div
				class="mt-16 text-center pb-8 opacity-80 hover:opacity-100 transition-opacity"
			>
				<p
					class="inline-flex items-center px-4 py-2 rounded-full bg-white/60 border border-white/60 text-slate-500 text-xs font-bold uppercase tracking-widest shadow-sm"
					id="dataInfo"
				>
					<span
						class="w-2.5 h-2.5 rounded-full bg-emerald-500 mr-2 animate-pulse shadow-sm shadow-emerald-200"
					></span>
					C·∫≠p nh·∫≠t: <span
						id="lastUpdateStr"
						class="ml-1 text-slate-800">--</span
					>
					<span class="mx-3 text-slate-300">|</span>
					<span id="memberCount" class="text-slate-800"
						>-- th√†nh vi√™n</span
					>
				</p>
			</div>
		</div>
	</main>
</Layout>

<style>
	@keyframes pulse-slow {
		0%,
		100% {
			opacity: 0.5;
			transform: scale(1);
		}
		50% {
			opacity: 0.8;
			transform: scale(1.1);
		}
	}
	.animate-pulse-slow {
		animation: pulse-slow 8s ease-in-out infinite;
	}

	@keyframes fade-in-up {
		from {
			opacity: 0;
			transform: translateY(20px);
		}
		to {
			opacity: 1;
			transform: translateY(0);
		}
	}
	.animate-fade-in-up {
		animation: fade-in-up 0.6s ease-out forwards;
	}

	/* Custom Scrollbar */
	::-webkit-scrollbar {
		width: 10px;
		height: 10px;
	}
	::-webkit-scrollbar-track {
		background: #f1f5f9;
		border-radius: 5px;
	}
	::-webkit-scrollbar-thumb {
		background: #cbd5e1;
		border-radius: 5px;
		border: 2px solid #f1f5f9;
	}
	::-webkit-scrollbar-thumb:hover {
		background: #94a3b8;
	}
</style>

<script>
	import { calculateUserStats } from "../utils/calculateStats.js";

	let currentChallengeId = "2";
	let currentSearchQuery = "";
	let allMembersWithStats = [];
	// Default to Discord, toggle checked state implies "Name" if unchecked or checked?
	// Let's say CHECKED = Name (On), UNCHECKED = Discord (Off) or vice versa.
	// User said "Switch Name and Discord".
	// Let's implement: OFF (Left) = Discord, ON (Right) = Name.
	let displayMode =
		localStorage.getItem("leaderboardDisplayMode") || "discord";

	// Challenge names mapping
	const challengeNames = {
		"1": "Anki Challenge 8",
		"2": "Anki Challenge 9",
		"3": "Anki Challenge 10",
	};

	const challengeDateRanges = {
		"1": { start: "2025-09-03", end: "2025-12-21" },
		"2": { start: "2025-12-22", end: "2026-03-31" },
		"3": { start: "2026-04-01", end: "2026-07-09" },
	};

	let studyRecordsData = null;
	let usersData = null;

	async function loadStaticData() {
		try {
			const metadataResponse = await fetch(
				"/data/metadata.json?v=" + Date.now(),
			);
			const metadata = await metadataResponse.json();
			const cacheBuster = metadata?.lastUpdated
				? "?v=" + new Date(metadata.lastUpdated).getTime()
				: "?v=" + Date.now();

			const lastUpdateStr = document.getElementById("lastUpdateStr");
			if (lastUpdateStr && metadata?.lastUpdated) {
				const date = new Date(metadata.lastUpdated);
				lastUpdateStr.textContent = date.toLocaleString("vi-VN", {
					hour: "2-digit",
					minute: "2-digit",
					day: "2-digit",
					month: "2-digit",
				});
			}

			const [studyRecordsResponse, usersResponse] = await Promise.all([
				fetch("/data/studyRecords.json" + cacheBuster),
				fetch("/data/users.json" + cacheBuster),
			]);

			studyRecordsData = await studyRecordsResponse.json();
			usersData = await usersResponse.json();
		} catch (error) {
			console.error("Error loading static data:", error);
			throw error;
		}
	}

	function calculateUserStatsForLeaderboard(userId, challengeId) {
		try {
			if (!studyRecordsData || !usersData)
				return {
					streak: 0,
					longestStreak: 0,
					totalDays: 0,
					disciplinePercentage: 0,
				};

			const users = usersData.data || [];
			const user = users.find((u) => u.id === userId);

			if (!user)
				return {
					streak: 0,
					longestStreak: 0,
					totalDays: 0,
					disciplinePercentage: 0,
				};

			const usersWithStats = calculateUserStats(
				[user],
				studyRecordsData,
				challengeId,
				challengeDateRanges,
			);

			if (usersWithStats.length === 0 || !usersWithStats[0].currentStat) {
				return {
					streak: 0,
					longestStreak: 0,
					totalDays: 0,
					disciplinePercentage: 0,
				};
			}

			const stat = usersWithStats[0].currentStat;

			return {
				streak: stat.streak,
				longestStreak: stat.longestStreak,
				totalDays: stat.totalDays,
				disciplinePercentage: stat.disciplinePercentage,
			};
		} catch (error) {
			console.error("[LEADERBOARD] Error calculating stats:", error);
			return {
				streak: 0,
				longestStreak: 0,
				totalDays: 0,
				disciplinePercentage: 0,
			};
		}
	}

	// --- OPTIMIZED RENDER LOGIC WITH CSS TOGGLE ---
	function getDisplayNameHTML(member) {
		const name = member.name || "Kh√¥ng c√≥ t√™n";
		const discord = member.discordNickname || name;
		// Render both, toggle visibility via CSS
		// Default show-discord is set on parent.
		// If .show-name on parent -> .name-display: block, .discord-display: hidden
		return `
			<span class="name-display hidden group-[.show-name]:inline text-ellipsis overflow-hidden whitespace-nowrap text-slate-900 font-bold">${name}</span>
			<span class="discord-display hidden group-[.show-discord]:inline text-ellipsis overflow-hidden whitespace-nowrap text-indigo-700 font-bold font-mono text-sm">${discord}</span>
		`;
	}

	function getMobileDisplayNameHTML(member) {
		const name = member.name || "Kh√¥ng c√≥ t√™n";
		const discord = member.discordNickname || name;
		return `
			<span class="name-display hidden group-[.show-name]:inline text-ellipsis overflow-hidden whitespace-nowrap text-slate-900 font-bold">${name}</span>
			<span class="discord-display hidden group-[.show-discord]:inline text-ellipsis overflow-hidden whitespace-nowrap text-indigo-700 font-bold font-mono text-sm">${discord}</span>
		`;
	}

	function updateMemberCount(challengeId) {
		try {
			if (!usersData || !usersData.data) {
				const memberCountEl = document.getElementById("memberCount");
				if (memberCountEl) memberCountEl.textContent = "-- th√†nh vi√™n";
				return;
			}
			const members = usersData.data || [];
			const challengeIdNum = parseInt(challengeId);
			const challengeMembers = members.filter(
				(m) =>
					!m.hidden &&
					m.challengeIds &&
					m.challengeIds.includes(challengeIdNum),
			);

			const memberCountEl = document.getElementById("memberCount");
			if (memberCountEl) {
				memberCountEl.textContent = `${challengeMembers.length} th√†nh vi√™n`;
			}
		} catch (error) {
			console.error("Error updating member count:", error);
		}
	}

	function updateDisplayModeConfig() {
		const toggle = document.getElementById("displayModeToggle");
		const label = document.getElementById("toggleLabel");
		const leaderboard = document.getElementById("leaderboard");

		if (toggle) {
			// If mode is 'name', toggle should be CHECKED (ON)
			toggle.checked = displayMode === "name";
		}

		if (label) {
			label.textContent = displayMode === "name" ? "T√™n th·∫≠t" : "Discord";
			label.className =
				displayMode === "name"
					? "ml-3 text-sm font-bold text-slate-900 w-20 text-center select-none transition-colors"
					: "ml-3 text-sm font-bold text-slate-500 w-20 text-center select-none transition-colors";
		}

		// Update CSS classes
		if (leaderboard) {
			leaderboard.classList.remove("show-name", "show-discord");
			if (displayMode === "name") {
				leaderboard.classList.add("show-name");
			} else {
				leaderboard.classList.add("show-discord");
			}
		}
	}

	async function loadLeaderboard(challengeId) {
		try {
			const loadingDiv = document.getElementById("loading");
			const leaderboardDiv = document.getElementById("leaderboard");
			const leaderboardBody = document.getElementById("leaderboardBody");
			const leaderboardCardsBody = document.getElementById(
				"leaderboardCardsBody",
			);

			if (loadingDiv) loadingDiv.classList.remove("hidden");
			if (leaderboardDiv) leaderboardDiv.classList.add("hidden");

			if (!usersData || !studyRecordsData) await loadStaticData();

			if (!usersData || !usersData.data) {
				if (loadingDiv)
					loadingDiv.innerHTML =
						'<p class="text-red-500">Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu</p>';
				return;
			}

			const members = usersData.data || [];
			const challengeIdNum = parseInt(challengeId);
			const challengeMembers = members.filter(
				(m) =>
					!m.hidden &&
					m.challengeIds &&
					m.challengeIds.includes(challengeIdNum),
			);

			updateMemberCount(challengeId);

			const membersWithStats = challengeMembers.map((member) => {
				const stats = calculateUserStatsForLeaderboard(
					member.id,
					challengeId,
				);
				return { ...member, ...stats };
			});

			membersWithStats.sort(
				(a, b) => b.disciplinePercentage - a.disciplinePercentage,
			);
			allMembersWithStats = membersWithStats;

			const filteredMembers = applySearchFilter(
				membersWithStats,
				currentSearchQuery,
			);

			if (loadingDiv) loadingDiv.classList.add("hidden");
			if (leaderboardDiv) leaderboardDiv.classList.remove("hidden");

			// Apply display mode classes immediately
			updateDisplayModeConfig();

			if (!leaderboardBody && !leaderboardCardsBody) return;

			if (filteredMembers.length === 0) {
				const emptyMessage = currentSearchQuery
					? `Kh√¥ng t√¨m th·∫•y th√†nh vi√™n n√†o v·ªõi t·ª´ kh√≥a "${currentSearchQuery}"`
					: "Ch∆∞a c√≥ th√†nh vi√™n n√†o trong challenge n√†y";
				if (leaderboardBody)
					leaderboardBody.innerHTML = `<tr><td colspan="6" class="px-6 py-12 text-center text-slate-500">${emptyMessage}</td></tr>`;
				if (leaderboardCardsBody)
					leaderboardCardsBody.innerHTML = `<div class="text-center text-slate-500 py-8 text-base">${emptyMessage}</div>`;
				return;
			}

			let currentRank = 1;
			allMembersWithStats.forEach((member, index) => {
				if (
					index > 0 &&
					member.disciplinePercentage <
						allMembersWithStats[index - 1].disciplinePercentage
				) {
					currentRank = index + 1;
				}
				member.rank = currentRank;
			});

			// --- LIGHT MODE RENDERING HELPERS (High Contrast) ---

			function getRankBadge(rank) {
				if (rank === 1)
					return '<span class="text-2xl mr-2 filter drop-shadow-md hover:scale-110 transition-transform cursor-help">üëë</span>';
				if (rank === 2)
					return '<span class="text-2xl mr-2 filter drop-shadow-md hover:scale-110 transition-transform cursor-help">ü•à</span>';
				if (rank === 3)
					return '<span class="text-2xl mr-2 filter drop-shadow-md hover:scale-110 transition-transform cursor-help">ü•â</span>';
				return "";
			}

			function getTopRowClass(rank) {
				if (rank === 1)
					return "bg-gradient-to-r from-amber-50 via-yellow-50/50 to-white hover:to-amber-100/30 border-l-[6px] border-amber-400";
				if (rank === 2)
					return "bg-gradient-to-r from-slate-100 via-slate-50/50 to-white hover:to-slate-200/30 border-l-[6px] border-slate-400";
				if (rank === 3)
					return "bg-gradient-to-r from-orange-50 via-orange-50/50 to-white hover:to-orange-100/30 border-l-[6px] border-orange-400";
				return "";
			}

			function getTotalDaysHighlightClass(totalDays) {
				const tier = Math.floor(totalDays / 10);
				const colorTiers = [
					{ bg: "", border: "" },
					{
						bg: "bg-cyan-50/50",
						border: "border-l-[3px] border-cyan-400",
					},
					{
						bg: "bg-teal-50/50",
						border: "border-l-[3px] border-teal-400",
					},
					{
						bg: "bg-emerald-50/50",
						border: "border-l-[3px] border-emerald-400",
					},
					{
						bg: "bg-green-50/50",
						border: "border-l-[3px] border-green-500",
					},
					{
						bg: "bg-lime-50/50",
						border: "border-l-[3px] border-lime-500",
					},
					{
						bg: "bg-yellow-50/50",
						border: "border-l-[3px] border-yellow-400",
					},
					{
						bg: "bg-amber-50/50",
						border: "border-l-[3px] border-amber-500",
					},
					{
						bg: "bg-orange-50/50",
						border: "border-l-[3px] border-orange-500",
					},
					{
						bg: "bg-red-50/50",
						border: "border-l-[3px] border-red-500",
					},
				];
				if (tier >= 10)
					return {
						bg: "bg-purple-50",
						border: "border-l-[4px] border-purple-500 shadow-[inset_0_0_15px_rgba(168,85,247,0.08)]",
					};
				return colorTiers[tier] || { bg: "", border: "" };
			}

			// Render Desktop Table (Light Mode - High Contrast)
			if (leaderboardBody) {
				leaderboardBody.innerHTML = filteredMembers
					.map((member) => {
						const rankBadge = getRankBadge(member.rank);
						const topRowClass = getTopRowClass(member.rank);
						const daysHighlight = getTotalDaysHighlightClass(
							member.totalDays,
						);
						const rowClass =
							topRowClass ||
							`${daysHighlight.bg} ${daysHighlight.border}`;

						let disciplineColor = "text-emerald-700";
						let barColor =
							"bg-emerald-500 shadow-[0_0_10px_rgba(16,185,129,0.4)]";
						if (member.disciplinePercentage < 50) {
							disciplineColor = "text-rose-700";
							barColor =
								"bg-rose-500 shadow-[0_0_10px_rgba(244,63,94,0.4)]";
						} else if (member.disciplinePercentage < 80) {
							disciplineColor = "text-amber-700";
							barColor =
								"bg-amber-500 shadow-[0_0_10px_rgba(245,158,11,0.4)]";
						}

						return `
						<tr class="group hover:bg-white transition-colors duration-200 ${rowClass}">
							<td class="px-8 py-5">
								<span class="font-bold text-xl text-slate-800 tabular-nums flex items-center">
									${rankBadge}<span class="${member.rank <= 3 ? "text-transparent bg-clip-text bg-gradient-to-r from-amber-600 to-orange-600 font-black" : "text-slate-500"}">#${member.rank}</span>
								</span>
							</td>
							<td class="px-8 py-5">
								<div class="flex items-center">
									<a href="/profile/${member.id}" target="_blank" class="font-bold text-slate-900 text-base hover:text-cyan-700 transition-colors flex items-center gap-2 max-w-[200px]">
										${getDisplayNameHTML(member)}
									</a>
									${member.role === "admin" ? '<span class="ml-2 text-[10px] uppercase font-black bg-purple-100 text-purple-700 px-2 py-0.5 rounded border border-purple-200 tracking-wider">Admin</span>' : ""}
								</div>
							</td>
							<td class="px-8 py-5 text-center">
								<span class="font-black text-cyan-700 tabular-nums text-xl">${member.streak}</span>
								<span class="text-xs text-slate-400 block font-bold uppercase tracking-wider mt-1">ng√†y</span>
							</td>
							<td class="px-8 py-5 text-center">
								<span class="font-bold text-slate-600 tabular-nums text-lg">${member.longestStreak}</span>
							</td>
							<td class="px-8 py-5 text-center">
								<span class="font-bold text-slate-800 tabular-nums text-lg">${member.totalDays}</span>
							</td>
							<td class="px-8 py-5 text-center">
								<div class="flex items-center justify-center gap-3">
									<div class="w-24 h-2.5 bg-slate-200 rounded-full overflow-hidden shadow-inner ring-1 ring-slate-100">
										<div class="h-full ${barColor}" style="width: ${member.disciplinePercentage}%"></div>
									</div>
									<span class="font-black ${disciplineColor} tabular-nums text-sm w-12 text-right">${member.disciplinePercentage}%</span>
								</div>
							</td>
						</tr>
					`;
					})
					.join("");
			}

			// Render Mobile Cards (Light Mode - High Contrast)
			function getTopCardClass(rank) {
				if (rank === 1)
					return "ring-4 ring-amber-400/50 bg-gradient-to-br from-amber-50 to-white";
				if (rank === 2)
					return "ring-4 ring-slate-400/50 bg-gradient-to-br from-slate-50 to-white";
				if (rank === 3)
					return "ring-4 ring-orange-400/50 bg-gradient-to-br from-orange-50 to-white";
				return "bg-white border border-slate-200";
			}

			function getTotalDaysCardClass(totalDays) {
				const tier = Math.floor(totalDays / 10);
				// Mobile uses subtle backgrounds
				if (tier >= 10)
					return "bg-purple-50/80 border-2 border-purple-300";

				const tiers = [
					"bg-white border border-slate-200",
					"bg-cyan-50/80 border border-cyan-200",
					"bg-teal-50/80 border border-teal-200",
					"bg-emerald-50/80 border border-emerald-200",
					"bg-green-50/80 border border-green-200",
					"bg-lime-50/80 border border-lime-200",
					"bg-yellow-50/80 border border-yellow-200",
					"bg-amber-50/80 border border-amber-200",
					"bg-orange-50/80 border border-orange-200",
					"bg-red-50/80 border border-red-200",
				];
				return tiers[tier] || "bg-white border border-slate-200";
			}

			if (leaderboardCardsBody) {
				leaderboardCardsBody.innerHTML = filteredMembers
					.map((member) => {
						const rankBadge = getRankBadge(member.rank);

						let cardClass = "";
						const topClass = getTopCardClass(member.rank);

						// If top 3, use top class, else use days highlight
						if (member.rank <= 3) {
							cardClass = topClass;
						} else {
							const daysClass = getTotalDaysCardClass(
								member.totalDays,
							);
							// Need to ensure border class is present
							if (daysClass.includes("border"))
								cardClass = daysClass;
							else
								cardClass = `${daysClass} border border-slate-200`;
						}

						let disciplineColor = "text-emerald-700";
						if (member.disciplinePercentage < 50)
							disciplineColor = "text-rose-700";
						else if (member.disciplinePercentage < 80)
							disciplineColor = "text-amber-700";

						return `
						<a
							href="/profile/${member.id}"
							target="_blank"
							class="block rounded-3xl p-6 ${cardClass} shadow-xl shadow-slate-200/60 active:scale-[0.98] transition-all"
						>
							<div class="flex items-start justify-between gap-3 mb-5">
								<div class="flex items-center gap-4 max-w-[70%]">
									<div class="flex items-center justify-center w-14 h-14 rounded-2xl bg-white border-2 border-slate-100 font-black text-xl text-slate-800 shadow-sm shrink-0">
										${member.rank <= 3 ? rankBadge : "#" + member.rank}
									</div>
									<div class="min-w-0">
										<div class="font-black text-xl text-slate-900 leading-tight flex items-center gap-2">
											${getMobileDisplayNameHTML(member)}
											${member.role === "admin" ? '<span class="text-[10px] uppercase font-black bg-purple-100 text-purple-700 px-1.5 py-0.5 rounded shrink-0">Admin</span>' : ""}
										</div>
										<div class="text-xs text-slate-400 font-mono mt-1 font-bold">ID: ${member.id}</div>
									</div>
								</div>
								<div class="text-right shrink-0">
									<div class="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-br from-cyan-600 to-blue-700 tabular-nums leading-none drop-shadow-sm">${member.streak}</div>
									<div class="text-[10px] uppercase tracking-wider text-slate-400 font-bold mt-1">Chu·ªói</div>
								</div>
							</div>

							<div class="grid grid-cols-3 gap-2 py-4 border-t border-black/5 bg-black/[0.02] -mx-6 px-6 mt-4">
								<div class="text-center">
									<div class="text-[10px] uppercase tracking-wider text-slate-400 font-bold mb-1">K·ª∑ l·ª•c</div>
									<div class="font-bold text-slate-600 tabular-nums text-lg">${member.longestStreak}</div>
								</div>
								<div class="text-center border-l border-black/5">
									<div class="text-[10px] uppercase tracking-wider text-slate-400 font-bold mb-1">T·ªïng</div>
									<div class="font-bold text-slate-800 tabular-nums text-lg">${member.totalDays}</div>
								</div>
								<div class="text-center border-l border-black/5">
									<div class="text-[10px] uppercase tracking-wider text-slate-400 font-bold mb-1">K·ª∑ lu·∫≠t</div>
									<div class="font-black ${disciplineColor} tabular-nums text-lg">${member.disciplinePercentage}%</div>
								</div>
							</div>
						</a>
					`;
					})
					.join("");
			}
		} catch (error) {
			console.error("Error loading leaderboard:", error);
			const loadingDiv = document.getElementById("loading");
			if (loadingDiv)
				loadingDiv.innerHTML = `<p class="text-red-500">L·ªói: ${error.message}</p>`;
		}
	}

	function applySearchFilter(members, searchQuery) {
		if (!searchQuery || searchQuery.trim() === "") return members;
		const query = searchQuery.trim().toLowerCase();
		return members.filter((member) => {
			const id = String(member.id || "").toLowerCase();
			const name = (member.name || "").toLowerCase();
			const discord = (member.discordNickname || "").toLowerCase();
			return (
				id.includes(query) ||
				name.includes(query) ||
				discord.includes(query)
			);
		});
	}

	function renderFilteredLeaderboard() {
		loadLeaderboard(currentChallengeId);
	}

	const challengeSelect = document.getElementById("challengeSelect");
	if (challengeSelect) {
		challengeSelect.addEventListener("change", (e) => {
			currentChallengeId = e.target.value;
			currentSearchQuery = "";
			const searchInput = document.getElementById("searchInput");
			if (searchInput) searchInput.value = "";
			const clearSearchBtn = document.getElementById("clearSearch");
			if (clearSearchBtn) clearSearchBtn.classList.add("hidden");
			if (window.updateProgressBar)
				window.updateProgressBar(currentChallengeId);
			const titleEl = document.getElementById("challengeTitle");
			// Update title logic...
			if (titleEl)
				titleEl.textContent = `${challengeNames[currentChallengeId]} - 100 ng√†y th·ª≠ th√°ch`;
			updateMemberCount(currentChallengeId);
			loadLeaderboard(currentChallengeId);
		});
	}

	const searchInput = document.getElementById("searchInput");
	const clearSearchBtn = document.getElementById("clearSearch");
	if (searchInput) {
		let searchTimeout;
		searchInput.addEventListener("input", (e) => {
			clearTimeout(searchTimeout);
			currentSearchQuery = e.target.value;
			if (clearSearchBtn) {
				if (currentSearchQuery.trim() !== "")
					clearSearchBtn.classList.remove("hidden");
				else clearSearchBtn.classList.add("hidden");
			}
			searchTimeout = setTimeout(() => {
				renderFilteredLeaderboard();
			}, 300);
		});
	}

	if (clearSearchBtn) {
		clearSearchBtn.addEventListener("click", () => {
			currentSearchQuery = "";
			if (searchInput) {
				searchInput.value = "";
				searchInput.focus();
			}
			clearSearchBtn.classList.add("hidden");
			renderFilteredLeaderboard();
		});
	}

	const displayModeToggle = document.getElementById("displayModeToggle");

	function switchDisplayMode(isNameMode) {
		displayMode = isNameMode ? "name" : "discord";
		localStorage.setItem("leaderboardDisplayMode", displayMode);
		updateDisplayModeConfig();
		// No re-render needed
	}

	if (displayModeToggle) {
		displayModeToggle.addEventListener("change", (e) => {
			switchDisplayMode(e.target.checked);
		});
	}

	// Initial styling (without waiting for JS)
	updateDisplayModeConfig();

	if ("requestIdleCallback" in window) {
		requestIdleCallback(
			async () => {
				await loadStaticData();
				updateMemberCount(currentChallengeId);
				loadLeaderboard(currentChallengeId);
			},
			{ timeout: 1000 },
		);
	} else {
		setTimeout(async () => {
			await loadStaticData();
			updateMemberCount(currentChallengeId);
			loadLeaderboard(currentChallengeId);
		}, 0);
	}
</script>
