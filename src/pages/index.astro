---
import Layout from '../layouts/Layout.astro';
import ProgressBar from '../components/ProgressBar.astro';
---

<Layout title="Anki Challenge - B·∫£ng x·∫øp h·∫°ng">
	<main class="min-h-screen aurora-bg py-6 sm:py-10 lg:py-12 px-4 relative">
		<!--
			T·ªëi ∆∞u mobile:
			- Gi·∫£m DOM/hi·ªáu ·ª©ng n·ªÅn kh√¥ng c·∫ßn thi·∫øt ƒë·ªÉ t·∫£i nhanh v√† cu·ªôn m∆∞·ª£t
			- Gi·ªØ giao di·ªán ƒë∆°n gi·∫£n, t·∫≠p trung v√†o d·ªØ li·ªáu
		-->
		
		<div class="max-w-5xl mx-auto relative z-10">
			<div class="text-center mb-6 sm:mb-8">
				<!-- Title and Challenge Selector Row -->
				<div class="flex flex-col sm:flex-row items-center justify-center gap-3 sm:gap-4 mb-3 sm:mb-4">
					<h1 class="text-3xl sm:text-5xl lg:text-6xl font-bold text-gray-900 leading-tight">B·∫£ng x·∫øp h·∫°ng</h1>
					<!-- Challenge Selector -->
					<div class="aurora-card rounded-xl p-2 w-full sm:w-auto">
						<label class="sr-only" for="challengeSelect">Ch·ªçn challenge</label>
						<select id="challengeSelect" class="w-full sm:w-auto min-h-[44px] px-4 sm:px-6 py-3 bg-transparent border-0 font-bold text-gray-900 focus:outline-none focus:ring-2 focus:ring-black rounded-lg text-base sm:text-lg">
							<option value="1">Anki Challenge 8</option>
							<option value="2" selected>Anki Challenge 9</option>
							<option value="3">Anki Challenge 10</option>
						</select>
					</div>
				</div>
				
				<p class="text-base sm:text-lg lg:text-xl font-semibold text-gray-700 mb-4" id="challengeTitle">Anki Challenge 9 - 100 ng√†y th·ª≠ th√°ch</p>
				
				<!-- Challenge Progress Bar -->
				<ProgressBar challengeId="2" />

				<!-- Search Bar and Display Mode Toggle -->
				<div class="mt-4 flex flex-col sm:flex-row items-center justify-center gap-3 sm:gap-4">
					<!-- Search Bar -->
					<div class="w-full sm:w-auto sm:max-w-md">
						<label class="sr-only" for="searchInput">T√¨m ki·∫øm th√†nh vi√™n</label>
						<div class="aurora-card rounded-xl p-2 relative">
							<div class="flex items-center gap-2">
								<svg class="w-5 h-5 text-gray-600 shrink-0 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
								</svg>
								<input 
									type="text" 
									id="searchInput" 
									placeholder="T√¨m ki·∫øm theo ID, t√™n ho·∫∑c Discord..." 
									class="flex-1 min-h-[44px] px-3 py-2 bg-transparent border-0 font-semibold text-gray-900 focus:outline-none text-base sm:text-lg placeholder:text-gray-500"
								/>
								<button 
									id="clearSearch" 
									class="hidden shrink-0 mr-2 p-1 text-gray-600 hover:text-gray-900 focus:outline-none focus:ring-2 focus:ring-black rounded"
									aria-label="X√≥a t√¨m ki·∫øm"
								>
									<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
									</svg>
								</button>
							</div>
						</div>
					</div>

					<!-- Display Mode Toggle -->
					<div class="aurora-card rounded-xl p-2 inline-flex gap-2">
						<button 
							id="displayNameBtn" 
							class="px-4 py-2 rounded-lg font-semibold text-sm transition-colors min-h-[44px] bg-white text-black swiss-border swiss-shadow-sm hover:bg-gray-50"
							aria-label="Hi·ªÉn th·ªã t√™n"
						>
							üë§ T√™n
						</button>
						<button 
							id="displayDiscordBtn" 
							class="px-4 py-2 rounded-lg font-semibold text-sm transition-colors min-h-[44px] aurora-button"
							aria-label="Hi·ªÉn th·ªã Discord nickname"
						>
							üí¨ Discord
						</button>
					</div>
				</div>
			</div>

			<div id="loading" class="text-center py-12">
				<div class="aurora-card inline-block px-8 py-6 rounded-2xl">
					<p class="text-gray-900 text-base sm:text-xl font-semibold">ƒêang t·∫£i d·ªØ li·ªáu‚Ä¶</p>
				</div>
			</div>

			<div id="leaderboard" class="hidden">
				<!-- Mobile: Card list (d·ªÖ ƒë·ªçc + v√πng ch·∫°m l·ªõn) -->
				<div class="sm:hidden" id="leaderboardCards" aria-label="B·∫£ng x·∫øp h·∫°ng (d·∫°ng th·∫ª)">
					<div class="aurora-card rounded-2xl p-4">
						<div id="leaderboardCardsBody" class="space-y-3"></div>
					</div>
				</div>

				<!-- Tablet/Desktop: Table -->
				<div class="hidden sm:block aurora-card leaderboard-table-card rounded-2xl overflow-hidden">
					<table class="w-full">
						<thead class="aurora-bg text-gray-900">
							<tr>
								<th class="px-4 lg:px-6 py-4 text-left text-sm font-bold">H·∫°ng</th>
								<th class="px-4 lg:px-6 py-4 text-left text-sm font-bold">T√™n</th>
								<th class="px-4 lg:px-6 py-4 text-center text-sm font-bold">Chu·ªói hi·ªán t·∫°i</th>
								<th class="px-4 lg:px-6 py-4 text-center text-sm font-bold">K·ª∑ l·ª•c</th>
								<th class="px-4 lg:px-6 py-4 text-center text-sm font-bold">T·ªïng ng√†y</th>
								<th class="px-4 lg:px-6 py-4 text-center text-sm font-bold">K·ª∑ lu·∫≠t</th>
							</tr>
						</thead>
						<tbody id="leaderboardBody" class="divide-y divide-gray-200 text-sm">
						</tbody>
					</table>
				</div>
			</div>
		</div>
	</main>
</Layout>

<script>
	import { calculateUserStats } from '../utils/calculateStats.js';

	let currentChallengeId = '2';
	let currentSearchQuery = '';
	let allMembersWithStats = []; // L∆∞u t·∫•t c·∫£ members ƒë·ªÉ filter
	let displayMode = localStorage.getItem('leaderboardDisplayMode') || 'discord'; // 'name' or 'discord'

	// Challenge names mapping
	const challengeNames = {
		'1': 'Anki Challenge 8',
		'2': 'Anki Challenge 9',
		'3': 'Anki Challenge 10'
	};

	// Challenge date ranges for leaderboard display (includes grace period)
	const challengeDateRanges = {
		'1': { start: '2025-09-03', end: '2025-12-21' },
		'2': { start: '2025-12-22', end: '2026-03-31' },
		'3': { start: '2026-04-01', end: '2026-07-09' }
	};

	// Load static data from JSON files
	let studyRecordsData = null;
	let usersData = null;

	async function loadStaticData() {
		try {
			// Load metadata tr∆∞·ªõc ƒë·ªÉ l·∫•y lastUpdated l√†m cache-buster
			// ƒê·∫£m b·∫£o lu√¥n l·∫•y d·ªØ li·ªáu m·ªõi nh·∫•t t·ª´ server
			const metadataResponse = await fetch('/data/metadata.json?v=' + Date.now());
			const metadata = await metadataResponse.json();
			const cacheBuster = metadata?.lastUpdated 
				? '?v=' + new Date(metadata.lastUpdated).getTime() 
				: '?v=' + Date.now();
			
			const [studyRecordsResponse, usersResponse] = await Promise.all([
				fetch('/data/studyRecords.json' + cacheBuster),
				fetch('/data/users.json' + cacheBuster)
			]);

			studyRecordsData = await studyRecordsResponse.json();
			usersData = await usersResponse.json();
		} catch (error) {
			console.error('Error loading static data:', error);
			throw error;
		}
	}

	// Calculate stats using shared utility function
	function calculateUserStatsForLeaderboard(userId, challengeId) {
		try {
			if (!studyRecordsData || !usersData) {
				return { streak: 0, longestStreak: 0, totalDays: 0, disciplinePercentage: 0 };
			}
			
			const users = usersData.data || [];
			const user = users.find(u => u.id === userId);
			
			if (!user) {
				return { streak: 0, longestStreak: 0, totalDays: 0, disciplinePercentage: 0 };
			}
			
			// Use shared calculateUserStats function
			const usersWithStats = calculateUserStats([user], studyRecordsData, challengeId, challengeDateRanges);
			
			if (usersWithStats.length === 0 || !usersWithStats[0].currentStat) {
				return { streak: 0, longestStreak: 0, totalDays: 0, disciplinePercentage: 0 };
			}
			
			const stat = usersWithStats[0].currentStat;
			
			return {
				streak: stat.streak,
				longestStreak: stat.longestStreak,
				totalDays: stat.totalDays,
				disciplinePercentage: stat.disciplinePercentage
			};
		} catch (error) {
			console.error('[LEADERBOARD] Error calculating stats:', error);
			return { streak: 0, longestStreak: 0, totalDays: 0, disciplinePercentage: 0 };
		}
	}

	// H√†m helper ƒë·ªÉ l·∫•y display name d·ª±a tr√™n displayMode
	function getDisplayName(member) {
		if (displayMode === 'discord' && member.discordNickname) {
			return member.discordNickname;
		}
		return member.name || 'Kh√¥ng c√≥ t√™n';
	}

	// H√†m c·∫≠p nh·∫≠t s·ªë th√†nh vi√™n trong challenge
	function updateMemberCount(challengeId) {
		try {
			if (!usersData || !usersData.data) {
				const memberCountEl = document.getElementById('memberCount');
				if (memberCountEl) memberCountEl.textContent = '-- th√†nh vi√™n';
				return;
			}

			const members = usersData.data || [];
			const challengeIdNum = parseInt(challengeId);
			const challengeMembers = members.filter(m => 
				!m.hidden && m.challengeIds && m.challengeIds.includes(challengeIdNum)
			);

			const memberCountEl = document.getElementById('memberCount');
			if (memberCountEl) {
				memberCountEl.textContent = `${challengeMembers.length} th√†nh vi√™n`;
			}
		} catch (error) {
			console.error('Error updating member count:', error);
		}
	}

	// H√†m c·∫≠p nh·∫≠t tr·∫°ng th√°i toggle buttons
	function updateDisplayModeButtons() {
		const nameBtn = document.getElementById('displayNameBtn');
		const discordBtn = document.getElementById('displayDiscordBtn');
		
		if (displayMode === 'name') {
			if (nameBtn) {
				nameBtn.className = 'px-4 py-2 rounded-lg font-semibold text-sm transition-colors min-h-[44px] aurora-button';
			}
			if (discordBtn) {
				discordBtn.className = 'px-4 py-2 rounded-lg font-semibold text-sm transition-colors min-h-[44px] bg-white text-black swiss-border swiss-shadow-sm hover:bg-gray-50';
			}
		} else {
			if (nameBtn) {
				nameBtn.className = 'px-4 py-2 rounded-lg font-semibold text-sm transition-colors min-h-[44px] bg-white text-black swiss-border swiss-shadow-sm hover:bg-gray-50';
			}
			if (discordBtn) {
				discordBtn.className = 'px-4 py-2 rounded-lg font-semibold text-sm transition-colors min-h-[44px] aurora-button';
			}
		}
	}

	async function loadLeaderboard(challengeId) {
		try {
			const loadingDiv = document.getElementById('loading');
			const leaderboardDiv = document.getElementById('leaderboard');
			const leaderboardBody = document.getElementById('leaderboardBody');
			const leaderboardCardsBody = document.getElementById('leaderboardCardsBody');

			if (loadingDiv) loadingDiv.classList.remove('hidden');
			if (leaderboardDiv) leaderboardDiv.classList.add('hidden');

			// Ensure static data is loaded
			if (!usersData || !studyRecordsData) {
				await loadStaticData();
			}

			if (!usersData || !usersData.data) {
				if (loadingDiv) loadingDiv.innerHTML = '<p class="text-red-500">Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu</p>';
				return;
			}

			const members = usersData.data || [];

			// Filter users in this challenge
			const challengeIdNum = parseInt(challengeId);
			const challengeMembers = members.filter(m => 
				!m.hidden && m.challengeIds && m.challengeIds.includes(challengeIdNum)
			);

			// C·∫≠p nh·∫≠t s·ªë th√†nh vi√™n
			updateMemberCount(challengeId);

			// Calculate stats for each member
			const membersWithStats = challengeMembers.map((member) => {
				const stats = calculateUserStatsForLeaderboard(member.id, challengeId);
				return { ...member, ...stats };
			});
			
			// Sort by discipline percentage
			membersWithStats.sort((a, b) => b.disciplinePercentage - a.disciplinePercentage);

			// L∆∞u t·∫•t c·∫£ members ƒë·ªÉ d√πng cho search filter
			allMembersWithStats = membersWithStats;

			// Apply search filter n·∫øu c√≥
			const filteredMembers = applySearchFilter(membersWithStats, currentSearchQuery);

			if (loadingDiv) loadingDiv.classList.add('hidden');
			if (leaderboardDiv) leaderboardDiv.classList.remove('hidden');
			if (!leaderboardBody && !leaderboardCardsBody) return;

			if (filteredMembers.length === 0) {
				if (leaderboardBody) {
					const emptyMessage = currentSearchQuery 
						? `Kh√¥ng t√¨m th·∫•y th√†nh vi√™n n√†o v·ªõi t·ª´ kh√≥a "${currentSearchQuery}"`
						: 'Ch∆∞a c√≥ th√†nh vi√™n n√†o trong challenge n√†y';
					leaderboardBody.innerHTML = `<tr><td colspan="6" class="px-6 py-12 text-center text-gray-500">${emptyMessage}</td></tr>`;
				}
				if (leaderboardCardsBody) {
					const emptyMessage = currentSearchQuery 
						? `Kh√¥ng t√¨m th·∫•y th√†nh vi√™n n√†o v·ªõi t·ª´ kh√≥a "${currentSearchQuery}"`
						: 'Ch∆∞a c√≥ th√†nh vi√™n n√†o trong challenge n√†y';
					leaderboardCardsBody.innerHTML = `<div class="text-center text-gray-600 py-8 text-base">${emptyMessage}</div>`;
				}
				return;
			}

			// Calculate ranks v·ªõi tie handling cho all members tr∆∞·ªõc
			let currentRank = 1;
			allMembersWithStats.forEach((member, index) => {
				if (index > 0 && member.disciplinePercentage < allMembersWithStats[index - 1].disciplinePercentage) {
					currentRank = index + 1;
				}
				member.rank = currentRank;
			});

			// Filtered members s·∫Ω gi·ªØ nguy√™n rank t·ª´ allMembersWithStats

			// H√†m helper t·∫°o badge cho Top 3
			function getRankBadge(rank) {
				if (rank === 1) return '<span class="text-lg mr-1">ü•á</span>';
				if (rank === 2) return '<span class="text-lg mr-1">ü•à</span>';
				if (rank === 3) return '<span class="text-lg mr-1">ü•â</span>';
				return '';
			}

			// H√†m helper t·∫°o class highlight cho Top 3 (Desktop)
			function getTopRowClass(rank) {
				if (rank === 1) return 'bg-amber-50 border-l-4 border-l-amber-400';
				if (rank === 2) return 'bg-slate-50 border-l-4 border-l-slate-400';
				if (rank === 3) return 'bg-orange-50 border-l-4 border-l-orange-400';
				return '';
			}

			// H√†m helper t·∫°o class highlight d·ª±a tr√™n t·ªïng ng√†y (chia 10 ng√†y 1 d·∫£i m√†u)
			function getTotalDaysHighlightClass(totalDays) {
				const tier = Math.floor(totalDays / 10);
				
				// M·∫£ng m√†u cho c√°c d·∫£i 10 ng√†y (0-9, 10-19, 20-29, ...)
				const colorTiers = [
					{ bg: '', border: '' }, // 0-9: kh√¥ng m√†u
					{ bg: 'bg-blue-50', border: 'border-l-4 border-l-blue-300' }, // 10-19: xanh nh·∫°t
					{ bg: 'bg-green-50', border: 'border-l-4 border-l-green-300' }, // 20-29: xanh l√° nh·∫°t
					{ bg: 'bg-emerald-50', border: 'border-l-4 border-l-emerald-300' }, // 30-39: xanh ng·ªçc nh·∫°t
					{ bg: 'bg-yellow-50', border: 'border-l-4 border-l-yellow-300' }, // 40-49: v√†ng nh·∫°t
					{ bg: 'bg-amber-50', border: 'border-l-4 border-l-amber-300' }, // 50-59: cam nh·∫°t
					{ bg: 'bg-orange-50', border: 'border-l-4 border-l-orange-300' }, // 60-69: cam ƒë·∫≠m h∆°n
					{ bg: 'bg-rose-50', border: 'border-l-4 border-l-rose-300' }, // 70-79: h·ªìng nh·∫°t
					{ bg: 'bg-purple-50', border: 'border-l-4 border-l-purple-300' }, // 80-89: t√≠m nh·∫°t
					{ bg: 'bg-indigo-50', border: 'border-l-4 border-l-indigo-300' }, // 90-99: ch√†m nh·∫°t
				];
				
				// T·ª´ 100 ng√†y tr·ªü l√™n d√πng m√†u ƒë·∫≠m nh·∫•t
				if (tier >= 10) {
					return { bg: 'bg-indigo-100', border: 'border-l-4 border-l-indigo-400' };
				}
				
				return colorTiers[tier] || { bg: '', border: '' };
			}

			// Desktop/tablet table render
			if (leaderboardBody) {
				leaderboardBody.innerHTML = filteredMembers.map((member) => {
					const rankBadge = getRankBadge(member.rank);
					const topRowClass = getTopRowClass(member.rank);
					// L·∫•y class highlight d·ª±a tr√™n t·ªïng ng√†y (∆∞u ti√™n top 3 n·∫øu c√≥)
					const daysHighlight = getTotalDaysHighlightClass(member.totalDays);
					// N·∫øu ƒë√£ c√≥ top row class (top 3) th√¨ kh√¥ng √°p d·ª•ng highlight theo ng√†y
					const rowClass = topRowClass || `${daysHighlight.bg} ${daysHighlight.border}`;
					
					return `
						<tr class="${rowClass}">
							<td class="px-4 lg:px-6 py-4">
								<span class="font-semibold text-gray-900 tabular-nums flex items-center">
									${rankBadge}${member.rank}
								</span>
							</td>
							<td class="px-4 lg:px-6 py-4">
								<a href="/profile/${member.id}" target="_blank" class="font-semibold text-gray-900 text-base hover:underline underline-offset-4 cursor-pointer">
									${getDisplayName(member)}
								</a>
								${member.role === 'admin' ? '<span class="text-xs border border-gray-900 text-gray-900 px-2 py-0.5 rounded-full ml-2">Admin</span>' : ''}
							</td>
							<td class="px-4 lg:px-6 py-4 text-center">
								<span class="font-semibold text-gray-900 tabular-nums">${member.streak}</span>
							</td>
							<td class="px-4 lg:px-6 py-4 text-center">
								<span class="font-semibold text-gray-900 tabular-nums">${member.longestStreak}</span>
							</td>
							<td class="px-4 lg:px-6 py-4 text-center">
								<span class="font-semibold text-gray-900 tabular-nums">${member.totalDays}</span>
							</td>
							<td class="px-4 lg:px-6 py-4 text-center">
								<span class="font-semibold text-gray-900 tabular-nums">${member.disciplinePercentage}%</span>
							</td>
						</tr>
					`;
				}).join('');
			}

			// H√†m helper t·∫°o class highlight cho Top 3 (Mobile)
			function getTopCardClass(rank) {
				if (rank === 1) return 'ring-2 ring-amber-400 bg-amber-50';
				if (rank === 2) return 'ring-2 ring-slate-400 bg-slate-50';
				if (rank === 3) return 'ring-2 ring-orange-400 bg-orange-50';
				return '';
			}

			// H√†m helper t·∫°o class highlight d·ª±a tr√™n t·ªïng ng√†y cho Mobile (chia 10 ng√†y 1 d·∫£i m√†u)
			function getTotalDaysCardClass(totalDays) {
				const tier = Math.floor(totalDays / 10);
				
				// M·∫£ng m√†u cho c√°c d·∫£i 10 ng√†y (d√πng ring v√† bg cho mobile)
				const colorTiers = [
					{ bg: '', ring: '' }, // 0-9: kh√¥ng m√†u
					{ bg: 'bg-blue-50', ring: 'ring-2 ring-blue-300' }, // 10-19: xanh nh·∫°t
					{ bg: 'bg-green-50', ring: 'ring-2 ring-green-300' }, // 20-29: xanh l√° nh·∫°t
					{ bg: 'bg-emerald-50', ring: 'ring-2 ring-emerald-300' }, // 30-39: xanh ng·ªçc nh·∫°t
					{ bg: 'bg-yellow-50', ring: 'ring-2 ring-yellow-300' }, // 40-49: v√†ng nh·∫°t
					{ bg: 'bg-amber-50', ring: 'ring-2 ring-amber-300' }, // 50-59: cam nh·∫°t
					{ bg: 'bg-orange-50', ring: 'ring-2 ring-orange-300' }, // 60-69: cam ƒë·∫≠m h∆°n
					{ bg: 'bg-rose-50', ring: 'ring-2 ring-rose-300' }, // 70-79: h·ªìng nh·∫°t
					{ bg: 'bg-purple-50', ring: 'ring-2 ring-purple-300' }, // 80-89: t√≠m nh·∫°t
					{ bg: 'bg-indigo-50', ring: 'ring-2 ring-indigo-300' }, // 90-99: ch√†m nh·∫°t
				];
				
				// T·ª´ 100 ng√†y tr·ªü l√™n d√πng m√†u ƒë·∫≠m nh·∫•t
				if (tier >= 10) {
					return { bg: 'bg-indigo-100', ring: 'ring-2 ring-indigo-400' };
				}
				
				return colorTiers[tier] || { bg: '', ring: '' };
			}

			// Mobile cards render (tap target >= 44px)
			if (leaderboardCardsBody) {
				leaderboardCardsBody.innerHTML = filteredMembers.map((member) => {
					const badge = member.role === 'admin'
						? '<span class="text-xs border border-gray-900 text-gray-900 px-2 py-0.5 rounded-full">Admin</span>'
						: '';
					const rankBadge = getRankBadge(member.rank);
					const topCardClass = getTopCardClass(member.rank);
					// L·∫•y class highlight d·ª±a tr√™n t·ªïng ng√†y (∆∞u ti√™n top 3 n·∫øu c√≥)
					const daysHighlight = getTotalDaysCardClass(member.totalDays);
					// N·∫øu ƒë√£ c√≥ top card class (top 3) th√¨ kh√¥ng √°p d·ª•ng highlight theo ng√†y
					const cardClass = topCardClass || `${daysHighlight.bg} ${daysHighlight.ring}`;

					return `
						<a
							href="/profile/${member.id}"
							target="_blank"
							class="block aurora-card rounded-xl p-5 min-h-[44px] focus:outline-none ${cardClass}"
							aria-label="M·ªü h·ªì s∆° ${getDisplayName(member)}"
						>
							<div class="flex items-start justify-between gap-3">
								<div class="min-w-0">
									<div class="flex items-center gap-2">
										<span class="font-semibold text-gray-900 text-sm tabular-nums flex items-center">${rankBadge}#${member.rank}</span>
										${badge}
									</div>
									<div class="mt-2 font-semibold text-gray-900 text-lg leading-snug break-words">${getDisplayName(member)}</div>
								</div>
								<div class="shrink-0 text-right">
									<div class="text-xs font-medium text-gray-600">K·ª∑ lu·∫≠t</div>
									<div class="text-lg font-semibold text-gray-900 tabular-nums">${member.disciplinePercentage}%</div>
								</div>
							</div>

							<div class="mt-4 pt-4 border-t border-gray-200 flex items-center justify-between gap-3">
								<div class="min-w-0">
									<div class="text-[11px] uppercase tracking-widest text-gray-600">Chu·ªói hi·ªán t·∫°i</div>
									<div class="text-base font-semibold text-gray-900 tabular-nums">${member.streak}</div>
								</div>
								<div class="min-w-0 text-center">
									<div class="text-[11px] uppercase tracking-widest text-gray-600">K·ª∑ l·ª•c</div>
									<div class="text-base font-semibold text-gray-900 tabular-nums">${member.longestStreak}</div>
								</div>
								<div class="min-w-0 text-right">
									<div class="text-[11px] uppercase tracking-widest text-gray-600">T·ªïng ng√†y</div>
									<div class="text-base font-semibold text-gray-900 tabular-nums">${member.totalDays}</div>
								</div>
							</div>
						</a>
					`;
				}).join('');
			}

		} catch (error) {
			console.error('Error loading leaderboard:', error);
			const loadingDiv = document.getElementById('loading');
			if (loadingDiv) {
				loadingDiv.innerHTML = `<p class="text-red-500">L·ªói: ${error.message}</p>`;
			}
		}
	}

	// H√†m filter members theo search query
	function applySearchFilter(members, searchQuery) {
		if (!searchQuery || searchQuery.trim() === '') {
			return members;
		}

		const query = searchQuery.trim().toLowerCase();
		return members.filter(member => {
			// T√¨m ki·∫øm theo ID (chuy·ªÉn sang string ƒë·ªÉ so s√°nh)
			const id = String(member.id || '').toLowerCase();
			const idMatch = id.includes(query);
			
			// T√¨m ki·∫øm theo t√™n (kh√¥ng ph√¢n bi·ªát hoa th∆∞·ªùng, h·ªó tr·ª£ ti·∫øng Vi·ªát)
			const name = (member.name || '').toLowerCase();
			const nameMatch = name.includes(query);
			
			// T√¨m ki·∫øm theo Discord nickname
			const discordNickname = (member.discordNickname || '').toLowerCase();
			const discordMatch = discordNickname.includes(query);
			
			// Tr·∫£ v·ªÅ true n·∫øu kh·ªõp v·ªõi b·∫•t k·ª≥ tr∆∞·ªùng n√†o
			return idMatch || nameMatch || discordMatch;
		});
	}

	// H√†m render l·∫°i leaderboard v·ªõi filter hi·ªán t·∫°i
	function renderFilteredLeaderboard() {
		if (allMembersWithStats.length === 0) return;
		
		const filteredMembers = applySearchFilter(allMembersWithStats, currentSearchQuery);
		const leaderboardBody = document.getElementById('leaderboardBody');
		const leaderboardCardsBody = document.getElementById('leaderboardCardsBody');

		if (filteredMembers.length === 0) {
			if (leaderboardBody) {
				const emptyMessage = currentSearchQuery 
					? `Kh√¥ng t√¨m th·∫•y th√†nh vi√™n n√†o v·ªõi t·ª´ kh√≥a "${currentSearchQuery}"`
					: 'Ch∆∞a c√≥ th√†nh vi√™n n√†o trong challenge n√†y';
				leaderboardBody.innerHTML = `<tr><td colspan="6" class="px-6 py-12 text-center text-gray-500">${emptyMessage}</td></tr>`;
			}
			if (leaderboardCardsBody) {
				const emptyMessage = currentSearchQuery 
					? `Kh√¥ng t√¨m th·∫•y th√†nh vi√™n n√†o v·ªõi t·ª´ kh√≥a "${currentSearchQuery}"`
					: 'Ch∆∞a c√≥ th√†nh vi√™n n√†o trong challenge n√†y';
				leaderboardCardsBody.innerHTML = `<div class="text-center text-gray-600 py-8 text-base">${emptyMessage}</div>`;
			}
			return;
		}

		// Rank ƒë√£ ƒë∆∞·ª£c t√≠nh trong allMembersWithStats, ch·ªâ c·∫ßn d√πng l·∫°i

		// H√†m helper t·∫°o badge cho Top 3
		function getRankBadge(rank) {
			if (rank === 1) return '<span class="text-lg mr-1">ü•á</span>';
			if (rank === 2) return '<span class="text-lg mr-1">ü•à</span>';
			if (rank === 3) return '<span class="text-lg mr-1">ü•â</span>';
			return '';
		}

		// H√†m helper t·∫°o class highlight cho Top 3 (Desktop)
		function getTopRowClass(rank) {
			if (rank === 1) return 'bg-amber-50 border-l-4 border-l-amber-400';
			if (rank === 2) return 'bg-slate-50 border-l-4 border-l-slate-400';
			if (rank === 3) return 'bg-orange-50 border-l-4 border-l-orange-400';
			return '';
		}

		// H√†m helper t·∫°o class highlight d·ª±a tr√™n t·ªïng ng√†y (chia 10 ng√†y 1 d·∫£i m√†u)
		function getTotalDaysHighlightClass(totalDays) {
			const tier = Math.floor(totalDays / 10);
			
			// M·∫£ng m√†u cho c√°c d·∫£i 10 ng√†y (0-9, 10-19, 20-29, ...)
			const colorTiers = [
				{ bg: '', border: '' }, // 0-9: kh√¥ng m√†u
				{ bg: 'bg-blue-50', border: 'border-l-4 border-l-blue-300' }, // 10-19: xanh nh·∫°t
				{ bg: 'bg-green-50', border: 'border-l-4 border-l-green-300' }, // 20-29: xanh l√° nh·∫°t
				{ bg: 'bg-emerald-50', border: 'border-l-4 border-l-emerald-300' }, // 30-39: xanh ng·ªçc nh·∫°t
				{ bg: 'bg-yellow-50', border: 'border-l-4 border-l-yellow-300' }, // 40-49: v√†ng nh·∫°t
				{ bg: 'bg-amber-50', border: 'border-l-4 border-l-amber-300' }, // 50-59: cam nh·∫°t
				{ bg: 'bg-orange-50', border: 'border-l-4 border-l-orange-300' }, // 60-69: cam ƒë·∫≠m h∆°n
				{ bg: 'bg-rose-50', border: 'border-l-4 border-l-rose-300' }, // 70-79: h·ªìng nh·∫°t
				{ bg: 'bg-purple-50', border: 'border-l-4 border-l-purple-300' }, // 80-89: t√≠m nh·∫°t
				{ bg: 'bg-indigo-50', border: 'border-l-4 border-l-indigo-300' }, // 90-99: ch√†m nh·∫°t
			];
			
			// T·ª´ 100 ng√†y tr·ªü l√™n d√πng m√†u ƒë·∫≠m nh·∫•t
			if (tier >= 10) {
				return { bg: 'bg-indigo-100', border: 'border-l-4 border-l-indigo-400' };
			}
			
			return colorTiers[tier] || { bg: '', border: '' };
		}

		// Desktop/tablet table render
		if (leaderboardBody) {
			leaderboardBody.innerHTML = filteredMembers.map((member) => {
				const rankBadge = getRankBadge(member.rank);
				const topRowClass = getTopRowClass(member.rank);
				// L·∫•y class highlight d·ª±a tr√™n t·ªïng ng√†y (∆∞u ti√™n top 3 n·∫øu c√≥)
				const daysHighlight = getTotalDaysHighlightClass(member.totalDays);
				// N·∫øu ƒë√£ c√≥ top row class (top 3) th√¨ kh√¥ng √°p d·ª•ng highlight theo ng√†y
				const rowClass = topRowClass || `${daysHighlight.bg} ${daysHighlight.border}`;
				
				return `
					<tr class="${rowClass}">
						<td class="px-4 lg:px-6 py-4">
							<span class="font-semibold text-gray-900 tabular-nums flex items-center">
								${rankBadge}${member.rank}
							</span>
						</td>
						<td class="px-4 lg:px-6 py-4">
							<a href="/profile/${member.id}" target="_blank" class="font-semibold text-gray-900 text-base hover:underline underline-offset-4 cursor-pointer">
								${getDisplayName(member)}
							</a>
							${member.role === 'admin' ? '<span class="text-xs border border-gray-900 text-gray-900 px-2 py-0.5 rounded-full ml-2">Admin</span>' : ''}
						</td>
						<td class="px-4 lg:px-6 py-4 text-center">
							<span class="font-semibold text-gray-900 tabular-nums">${member.streak}</span>
						</td>
						<td class="px-4 lg:px-6 py-4 text-center">
							<span class="font-semibold text-gray-900 tabular-nums">${member.longestStreak}</span>
						</td>
						<td class="px-4 lg:px-6 py-4 text-center">
							<span class="font-semibold text-gray-900 tabular-nums">${member.totalDays}</span>
						</td>
						<td class="px-4 lg:px-6 py-4 text-center">
							<span class="font-semibold text-gray-900 tabular-nums">${member.disciplinePercentage}%</span>
						</td>
					</tr>
				`;
			}).join('');
		}

		// H√†m helper t·∫°o class highlight cho Top 3 (Mobile)
		function getTopCardClass(rank) {
			if (rank === 1) return 'ring-2 ring-amber-400 bg-amber-50';
			if (rank === 2) return 'ring-2 ring-slate-400 bg-slate-50';
			if (rank === 3) return 'ring-2 ring-orange-400 bg-orange-50';
			return '';
		}

		// H√†m helper t·∫°o class highlight d·ª±a tr√™n t·ªïng ng√†y cho Mobile (chia 10 ng√†y 1 d·∫£i m√†u)
		function getTotalDaysCardClass(totalDays) {
			const tier = Math.floor(totalDays / 10);
			
			// M·∫£ng m√†u cho c√°c d·∫£i 10 ng√†y (d√πng ring v√† bg cho mobile)
			const colorTiers = [
				{ bg: '', ring: '' }, // 0-9: kh√¥ng m√†u
				{ bg: 'bg-blue-50', ring: 'ring-2 ring-blue-300' }, // 10-19: xanh nh·∫°t
				{ bg: 'bg-green-50', ring: 'ring-2 ring-green-300' }, // 20-29: xanh l√° nh·∫°t
				{ bg: 'bg-emerald-50', ring: 'ring-2 ring-emerald-300' }, // 30-39: xanh ng·ªçc nh·∫°t
				{ bg: 'bg-yellow-50', ring: 'ring-2 ring-yellow-300' }, // 40-49: v√†ng nh·∫°t
				{ bg: 'bg-amber-50', ring: 'ring-2 ring-amber-300' }, // 50-59: cam nh·∫°t
				{ bg: 'bg-orange-50', ring: 'ring-2 ring-orange-300' }, // 60-69: cam ƒë·∫≠m h∆°n
				{ bg: 'bg-rose-50', ring: 'ring-2 ring-rose-300' }, // 70-79: h·ªìng nh·∫°t
				{ bg: 'bg-purple-50', ring: 'ring-2 ring-purple-300' }, // 80-89: t√≠m nh·∫°t
				{ bg: 'bg-indigo-50', ring: 'ring-2 ring-indigo-300' }, // 90-99: ch√†m nh·∫°t
			];
			
			// T·ª´ 100 ng√†y tr·ªü l√™n d√πng m√†u ƒë·∫≠m nh·∫•t
			if (tier >= 10) {
				return { bg: 'bg-indigo-100', ring: 'ring-2 ring-indigo-400' };
			}
			
			return colorTiers[tier] || { bg: '', ring: '' };
		}

		// Mobile cards render
		if (leaderboardCardsBody) {
			leaderboardCardsBody.innerHTML = filteredMembers.map((member) => {
				const badge = member.role === 'admin'
					? '<span class="text-xs border border-gray-900 text-gray-900 px-2 py-0.5 rounded-full">Admin</span>'
					: '';
				const rankBadge = getRankBadge(member.rank);
				const topCardClass = getTopCardClass(member.rank);
				// L·∫•y class highlight d·ª±a tr√™n t·ªïng ng√†y (∆∞u ti√™n top 3 n·∫øu c√≥)
				const daysHighlight = getTotalDaysCardClass(member.totalDays);
				// N·∫øu ƒë√£ c√≥ top card class (top 3) th√¨ kh√¥ng √°p d·ª•ng highlight theo ng√†y
				const cardClass = topCardClass || `${daysHighlight.bg} ${daysHighlight.ring}`;

				return `
					<a
						href="/profile/${member.id}"
						target="_blank"
						class="block aurora-card rounded-xl p-5 min-h-[44px] focus:outline-none ${cardClass}"
						aria-label="M·ªü h·ªì s∆° ${getDisplayName(member)}"
					>
						<div class="flex items-start justify-between gap-3">
							<div class="min-w-0">
								<div class="flex items-center gap-2">
									<span class="font-semibold text-gray-900 text-sm tabular-nums flex items-center">${rankBadge}#${member.rank}</span>
									${badge}
								</div>
								<div class="mt-2 font-semibold text-gray-900 text-lg leading-snug break-words">${getDisplayName(member)}</div>
							</div>
							<div class="shrink-0 text-right">
								<div class="text-xs font-medium text-gray-600">K·ª∑ lu·∫≠t</div>
								<div class="text-lg font-semibold text-gray-900 tabular-nums">${member.disciplinePercentage}%</div>
							</div>
						</div>

						<div class="mt-4 pt-4 border-t border-gray-200 flex items-center justify-between gap-3">
							<div class="min-w-0">
								<div class="text-[11px] uppercase tracking-widest text-gray-600">Chu·ªói hi·ªán t·∫°i</div>
								<div class="text-base font-semibold text-gray-900 tabular-nums">${member.streak}</div>
							</div>
							<div class="min-w-0 text-center">
								<div class="text-[11px] uppercase tracking-widest text-gray-600">K·ª∑ l·ª•c</div>
								<div class="text-base font-semibold text-gray-900 tabular-nums">${member.longestStreak}</div>
							</div>
							<div class="min-w-0 text-right">
								<div class="text-[11px] uppercase tracking-widest text-gray-600">T·ªïng ng√†y</div>
								<div class="text-base font-semibold text-gray-900 tabular-nums">${member.totalDays}</div>
							</div>
						</div>
					</a>
				`;
			}).join('');
		}
	}

	// Handle challenge selection
	const challengeSelect = document.getElementById('challengeSelect');
	if (challengeSelect) {
		challengeSelect.addEventListener('change', (e) => {
			currentChallengeId = e.target.value;
			// Clear search khi ƒë·ªïi challenge
			currentSearchQuery = '';
			const searchInput = document.getElementById('searchInput');
			if (searchInput) {
				searchInput.value = '';
			}
			const clearSearchBtn = document.getElementById('clearSearch');
			if (clearSearchBtn) {
				clearSearchBtn.classList.add('hidden');
			}
			
			if (window.updateProgressBar) {
				window.updateProgressBar(currentChallengeId);
			}
			const titleEl = document.getElementById('challengeTitle');
			if (titleEl) {
				titleEl.textContent = `${challengeNames[currentChallengeId]} - 100 ng√†y th·ª≠ th√°ch`;
			}
			// C·∫≠p nh·∫≠t s·ªë th√†nh vi√™n khi ƒë·ªïi challenge
			if (usersData) {
				updateMemberCount(currentChallengeId);
			}
			loadLeaderboard(currentChallengeId);
		});
	}

	// Handle search input
	const searchInput = document.getElementById('searchInput');
	const clearSearchBtn = document.getElementById('clearSearch');
	
	if (searchInput) {
		// T√¨m ki·∫øm khi g√µ (debounce ƒë·ªÉ t·ªëi ∆∞u performance)
		let searchTimeout;
		searchInput.addEventListener('input', (e) => {
			clearTimeout(searchTimeout);
			currentSearchQuery = e.target.value;
			
			// Hi·ªán/·∫©n n√∫t clear
			if (clearSearchBtn) {
				if (currentSearchQuery.trim() !== '') {
					clearSearchBtn.classList.remove('hidden');
				} else {
					clearSearchBtn.classList.add('hidden');
				}
			}
			
			// Debounce: ƒë·ª£i 300ms sau khi user ng·ª´ng g√µ m·ªõi filter
			searchTimeout = setTimeout(() => {
				renderFilteredLeaderboard();
			}, 300);
		});
	}

	// Handle clear search button
	if (clearSearchBtn) {
		clearSearchBtn.addEventListener('click', () => {
			currentSearchQuery = '';
			if (searchInput) {
				searchInput.value = '';
				searchInput.focus();
			}
			clearSearchBtn.classList.add('hidden');
			renderFilteredLeaderboard();
		});
	}

	// Handle display mode toggle buttons
	const displayNameBtn = document.getElementById('displayNameBtn');
	const displayDiscordBtn = document.getElementById('displayDiscordBtn');
	
	function switchDisplayMode(mode) {
		displayMode = mode;
		localStorage.setItem('leaderboardDisplayMode', mode);
		updateDisplayModeButtons();
		renderFilteredLeaderboard();
	}
	
	if (displayNameBtn) {
		displayNameBtn.addEventListener('click', () => {
			switchDisplayMode('name');
		});
	}
	
	if (displayDiscordBtn) {
		displayDiscordBtn.addEventListener('click', () => {
			switchDisplayMode('discord');
		});
	}
	
	// Initialize display mode buttons
	updateDisplayModeButtons();

	// Load initial leaderboard
	// T·ªëi ∆∞u c·∫£m gi√°c m∆∞·ª£t tr√™n mobile: ƒë·ª£i browser r·∫£nh r·ªìi m·ªõi t√≠nh to√°n b·∫£ng (tr√°nh gi·∫≠t)
	if ('requestIdleCallback' in window) {
		requestIdleCallback(async () => {
			await loadStaticData();
			updateMemberCount(currentChallengeId);
			loadLeaderboard(currentChallengeId);
		}, { timeout: 1000 });
	} else {
		setTimeout(async () => {
			await loadStaticData();
			updateMemberCount(currentChallengeId);
			loadLeaderboard(currentChallengeId);
		}, 0);
	}
</script>