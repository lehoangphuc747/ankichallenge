---
import Layout from '../layouts/Layout.astro';
import ProgressBar from '../components/ProgressBar.astro';
---

<Layout title="Anki Challenge - Bảng xếp hạng">
	<main class="min-h-screen aurora-bg py-6 sm:py-10 lg:py-12 px-4 relative">
		<!--
			Tối ưu mobile:
			- Giảm DOM/hiệu ứng nền không cần thiết để tải nhanh và cuộn mượt
			- Giữ giao diện đơn giản, tập trung vào dữ liệu
		-->
		
		<div class="max-w-5xl mx-auto relative z-10">
			<div class="text-center mb-6 sm:mb-8">
				<h1 class="text-3xl sm:text-5xl lg:text-6xl font-bold text-gray-900 mb-3 sm:mb-4 leading-tight">Bảng xếp hạng</h1>
				<p class="text-base sm:text-lg lg:text-xl font-semibold text-gray-700 mb-4" id="challengeTitle">Anki Challenge 8 - 100 ngày thử thách</p>
				
				<!-- Challenge Progress Bar -->
				<ProgressBar challengeId="1" />
				
				<!-- Challenge Selector -->
				<div class="inline-block aurora-card rounded-xl p-2 w-full sm:w-auto">
					<label class="sr-only" for="challengeSelect">Chọn challenge</label>
					<select id="challengeSelect" class="w-full sm:w-auto min-h-[44px] px-4 sm:px-6 py-3 bg-transparent border-0 font-bold text-gray-900 focus:outline-none focus:ring-2 focus:ring-black rounded-lg text-base sm:text-lg">
						<option value="1">Anki Challenge 8</option>
						<option value="2">Anki Challenge 9</option>
						<option value="3">Anki Challenge 10</option>
					</select>
				</div>
			</div>

			<div id="loading" class="text-center py-12">
				<div class="aurora-card inline-block px-8 py-6 rounded-2xl">
					<p class="text-gray-900 text-base sm:text-xl font-semibold">Đang tải dữ liệu…</p>
				</div>
			</div>

			<div id="leaderboard" class="hidden">
				<!-- Mobile: Card list (dễ đọc + vùng chạm lớn) -->
				<div class="sm:hidden" id="leaderboardCards" aria-label="Bảng xếp hạng (dạng thẻ)">
					<div class="aurora-card rounded-2xl p-4">
						<div id="leaderboardCardsBody" class="space-y-3"></div>
					</div>
				</div>

				<!-- Tablet/Desktop: Table -->
				<div class="hidden sm:block aurora-card rounded-2xl overflow-hidden">
					<table class="w-full">
						<thead class="aurora-bg text-gray-900">
							<tr>
								<th class="px-4 lg:px-6 py-4 text-left text-sm font-bold">Hạng</th>
								<th class="px-4 lg:px-6 py-4 text-left text-sm font-bold">Tên</th>
								<th class="px-4 lg:px-6 py-4 text-center text-sm font-bold">Chuỗi hiện tại</th>
								<th class="px-4 lg:px-6 py-4 text-center text-sm font-bold">Kỷ lục</th>
								<th class="px-4 lg:px-6 py-4 text-center text-sm font-bold">Tổng ngày</th>
								<th class="px-4 lg:px-6 py-4 text-center text-sm font-bold">Kỷ luật</th>
							</tr>
						</thead>
						<tbody id="leaderboardBody" class="divide-y divide-gray-200 text-sm">
						</tbody>
					</table>
				</div>
			</div>
		</div>
	</main>
</Layout>

<script>
	import { calculateUserStats } from '../utils/calculateStats.js';

	let currentChallengeId = '1';

	// Challenge names mapping
	const challengeNames = {
		'1': 'Anki Challenge 8',
		'2': 'Anki Challenge 9',
		'3': 'Anki Challenge 10'
	};

	// Challenge date ranges for leaderboard display (includes grace period)
	const challengeDateRanges = {
		'1': { start: '2025-09-03', end: '2025-12-21' },
		'2': { start: '2025-12-22', end: '2026-03-31' },
		'3': { start: '2026-05-01', end: '2026-08-09' }
	};

	// Load static data from JSON files
	let studyRecordsData = null;
	let usersData = null;

	async function loadStaticData() {
		try {
			// Tối ưu mobile: dữ liệu là file tĩnh nên ưu tiên cache để tải nhanh hơn cho lần sau
			const [studyRecordsResponse, usersResponse] = await Promise.all([
				fetch('/data/studyRecords.json', { cache: 'force-cache' }),
				fetch('/data/users.json', { cache: 'force-cache' })
			]);

			studyRecordsData = await studyRecordsResponse.json();
			usersData = await usersResponse.json();
		} catch (error) {
			console.error('Error loading static data:', error);
			throw error;
		}
	}

	// Calculate stats using shared utility function
	function calculateUserStatsForLeaderboard(userId, challengeId) {
		try {
			if (!studyRecordsData || !usersData) {
				return { streak: 0, longestStreak: 0, totalDays: 0, disciplinePercentage: 0 };
			}
			
			const users = usersData.data || [];
			const user = users.find(u => u.id === userId);
			
			if (!user) {
				return { streak: 0, longestStreak: 0, totalDays: 0, disciplinePercentage: 0 };
			}
			
			// Use shared calculateUserStats function
			const usersWithStats = calculateUserStats([user], studyRecordsData, challengeId, challengeDateRanges);
			
			if (usersWithStats.length === 0 || !usersWithStats[0].currentStat) {
				return { streak: 0, longestStreak: 0, totalDays: 0, disciplinePercentage: 0 };
			}
			
			const stat = usersWithStats[0].currentStat;
			
			return {
				streak: stat.streak,
				longestStreak: stat.longestStreak,
				totalDays: stat.totalDays,
				disciplinePercentage: stat.disciplinePercentage
			};
		} catch (error) {
			console.error('[LEADERBOARD] Error calculating stats:', error);
			return { streak: 0, longestStreak: 0, totalDays: 0, disciplinePercentage: 0 };
		}
	}

	async function loadLeaderboard(challengeId) {
		try {
			const loadingDiv = document.getElementById('loading');
			const leaderboardDiv = document.getElementById('leaderboard');
			const leaderboardBody = document.getElementById('leaderboardBody');
			const leaderboardCardsBody = document.getElementById('leaderboardCardsBody');

			if (loadingDiv) loadingDiv.classList.remove('hidden');
			if (leaderboardDiv) leaderboardDiv.classList.add('hidden');

			// Ensure static data is loaded
			if (!usersData || !studyRecordsData) {
				await loadStaticData();
			}

			if (!usersData || !usersData.data) {
				if (loadingDiv) loadingDiv.innerHTML = '<p class="text-red-500">Không tìm thấy dữ liệu</p>';
				return;
			}

			const members = usersData.data || [];

			// Filter users in this challenge
			const challengeIdNum = parseInt(challengeId);
			const challengeMembers = members.filter(m => 
				!m.hidden && m.challengeIds && m.challengeIds.includes(challengeIdNum)
			);

			// Calculate stats for each member
			const membersWithStats = challengeMembers.map((member) => {
				const stats = calculateUserStatsForLeaderboard(member.id, challengeId);
				return { ...member, ...stats };
			});
			
			// Sort by discipline percentage
			membersWithStats.sort((a, b) => b.disciplinePercentage - a.disciplinePercentage);

			if (loadingDiv) loadingDiv.classList.add('hidden');
			if (leaderboardDiv) leaderboardDiv.classList.remove('hidden');
			if (!leaderboardBody && !leaderboardCardsBody) return;

			if (membersWithStats.length === 0) {
				if (leaderboardBody) {
					leaderboardBody.innerHTML = '<tr><td colspan="6" class="px-6 py-12 text-center text-gray-500">Chưa có thành viên nào trong challenge này</td></tr>';
				}
				if (leaderboardCardsBody) {
					leaderboardCardsBody.innerHTML = '<div class="text-center text-gray-600 py-8 text-base">Chưa có thành viên nào trong challenge này</div>';
				}
				return;
			}

			// Calculate ranks with tie handling
			let currentRank = 1;
			membersWithStats.forEach((member, index) => {
				if (index > 0 && member.disciplinePercentage < membersWithStats[index - 1].disciplinePercentage) {
					currentRank = index + 1;
				}
				member.rank = currentRank;
			});

			// Desktop/tablet table render
			if (leaderboardBody) {
				leaderboardBody.innerHTML = membersWithStats.map((member) => {
					return `
						<tr>
							<td class="px-4 lg:px-6 py-4">
								<span class="font-semibold text-gray-900 tabular-nums">${member.rank}</span>
							</td>
							<td class="px-4 lg:px-6 py-4">
								<a href="/profile/${member.id}" target="_blank" class="font-semibold text-gray-900 text-base hover:underline underline-offset-4 cursor-pointer">
									${member.name}
								</a>
								${member.role === 'admin' ? '<span class="text-xs border border-gray-900 text-gray-900 px-2 py-0.5 rounded-full ml-2">Admin</span>' : ''}
							</td>
							<td class="px-4 lg:px-6 py-4 text-center">
								<span class="font-semibold text-gray-900 tabular-nums">${member.streak}</span>
							</td>
							<td class="px-4 lg:px-6 py-4 text-center">
								<span class="font-semibold text-gray-900 tabular-nums">${member.longestStreak}</span>
							</td>
							<td class="px-4 lg:px-6 py-4 text-center">
								<span class="font-semibold text-gray-900 tabular-nums">${member.totalDays}</span>
							</td>
							<td class="px-4 lg:px-6 py-4 text-center">
								<span class="font-semibold text-gray-900 tabular-nums">${member.disciplinePercentage}%</span>
							</td>
						</tr>
					`;
				}).join('');
			}

			// Mobile cards render (tap target >= 44px)
			if (leaderboardCardsBody) {
				leaderboardCardsBody.innerHTML = membersWithStats.map((member) => {
					const badge = member.role === 'admin'
						? '<span class="text-xs border border-gray-900 text-gray-900 px-2 py-0.5 rounded-full">Admin</span>'
						: '';

					return `
						<a
							href="/profile/${member.id}"
							target="_blank"
							class="block aurora-card rounded-xl p-5 min-h-[44px] focus:outline-none"
							aria-label="Mở hồ sơ ${member.name}"
						>
							<div class="flex items-start justify-between gap-3">
								<div class="min-w-0">
									<div class="flex items-center gap-2">
										<span class="font-semibold text-gray-900 text-sm tabular-nums">#${member.rank}</span>
										${badge}
									</div>
									<div class="mt-2 font-semibold text-gray-900 text-lg leading-snug break-words">${member.name}</div>
								</div>
								<div class="shrink-0 text-right">
									<div class="text-xs font-medium text-gray-600">Kỷ luật</div>
									<div class="text-lg font-semibold text-gray-900 tabular-nums">${member.disciplinePercentage}%</div>
								</div>
							</div>

							<div class="mt-4 pt-4 border-t border-gray-200 flex items-center justify-between gap-3">
								<div class="min-w-0">
									<div class="text-[11px] uppercase tracking-widest text-gray-600">Chuỗi hiện tại</div>
									<div class="text-base font-semibold text-gray-900 tabular-nums">${member.streak}</div>
								</div>
								<div class="min-w-0 text-center">
									<div class="text-[11px] uppercase tracking-widest text-gray-600">Kỷ lục</div>
									<div class="text-base font-semibold text-gray-900 tabular-nums">${member.longestStreak}</div>
								</div>
								<div class="min-w-0 text-right">
									<div class="text-[11px] uppercase tracking-widest text-gray-600">Tổng ngày</div>
									<div class="text-base font-semibold text-gray-900 tabular-nums">${member.totalDays}</div>
								</div>
							</div>
						</a>
					`;
				}).join('');
			}

		} catch (error) {
			console.error('Error loading leaderboard:', error);
			const loadingDiv = document.getElementById('loading');
			if (loadingDiv) {
				loadingDiv.innerHTML = `<p class="text-red-500">Lỗi: ${error.message}</p>`;
			}
		}
	}

	// Handle challenge selection
	const challengeSelect = document.getElementById('challengeSelect');
	if (challengeSelect) {
		challengeSelect.addEventListener('change', (e) => {
			currentChallengeId = e.target.value;
			if (window.updateProgressBar) {
				window.updateProgressBar(currentChallengeId);
			}
			const titleEl = document.getElementById('challengeTitle');
			if (titleEl) {
				titleEl.textContent = `${challengeNames[currentChallengeId]} - 100 ngày thử thách`;
			}
			loadLeaderboard(currentChallengeId);
		});
	}

	// Load initial leaderboard
	// Tối ưu cảm giác mượt trên mobile: đợi browser rảnh rồi mới tính toán bảng (tránh giật)
	if ('requestIdleCallback' in window) {
		requestIdleCallback(() => loadLeaderboard(currentChallengeId), { timeout: 1000 });
	} else {
		setTimeout(() => loadLeaderboard(currentChallengeId), 0);
	}
</script>