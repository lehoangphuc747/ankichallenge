---
import Layout from "../../layouts/Layout.astro";
import AdminCalendar from "../../components/admin/AdminCalendar";

// ğŸ”’ Báº¢O Vá»†: Chá»‰ cho phÃ©p truy cáº­p khi cháº¡y localhost (dev)
// Khi deploy lÃªn production, sáº½ tá»± Ä‘á»™ng redirect vá» trang chá»§
if (import.meta.env.PROD) {
  return Astro.redirect("/", 302);
}
---

<Layout title="Admin Check-in - Anki Challenge">
  <main
    class="min-h-screen bg-gradient-to-br from-green-50 via-blue-50 to-purple-50 py-8 px-4"
  >
    <div class="max-w-7xl mx-auto">
      <!-- Header -->
      <div class="flex items-center justify-between mb-8">
        <div class="flex-1">
          <h1
            class="text-4xl font-bold bg-gradient-to-r from-green-600 to-blue-600 bg-clip-text text-transparent mb-2"
          >
            âœ… Quáº£n lÃ½ Check-in
          </h1>
          <p class="text-gray-600">Click vÃ o hÃ ng Ä‘á»ƒ check/uncheck nhanh</p>
        </div>
        <div class="flex items-center gap-4">
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2"
              >Challenge</label
            >
            <select
              id="challengeSelect"
              class="px-4 py-2 border-2 border-blue-300 rounded-lg font-semibold text-gray-700 bg-white hover:border-blue-400 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
            >
              <option value="">Äang táº£i...</option>
            </select>
          </div>
          <a
            href="/admin"
            class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors mt-7"
          >
            â† Dashboard
          </a>
        </div>
      </div>

      <!-- Date Selector & Stats -->
      <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
        <!-- Date Selector (React Component) -->
        <div class="mb-6 flex justify-center">
          <AdminCalendar client:visible />
          <!-- Hidden input for backward compatibility with existing scripts (if needed) -->
          <input type="hidden" id="selectedDate" />
        </div>

        <!-- Stats -->
        <div class="grid grid-cols-3 gap-4">
          <div
            class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-xl p-4 text-center border-2 border-green-200"
          >
            <p class="text-sm text-gray-600 mb-1 font-semibold">
              âœ… ÄÃ£ check-in
            </p>
            <p class="text-3xl font-bold text-green-600" id="checkedCount">0</p>
          </div>
          <div
            class="bg-gradient-to-br from-orange-50 to-red-50 rounded-xl p-4 text-center border-2 border-orange-200"
          >
            <p class="text-sm text-gray-600 mb-1 font-semibold">
              â³ ChÆ°a check-in
            </p>
            <p class="text-3xl font-bold text-orange-600" id="uncheckedCount">
              0
            </p>
          </div>
          <div
            class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl p-4 text-center border-2 border-blue-200"
          >
            <p class="text-sm text-gray-600 mb-1 font-semibold">ğŸ“Š Tá»· lá»‡</p>
            <p class="text-3xl font-bold text-blue-600" id="checkinRate">0%</p>
          </div>
        </div>
      </div>

      <!-- Toast Notification -->
      <div id="toast" class="fixed top-4 right-4 z-50 hidden">
        <div
          class="bg-white rounded-lg shadow-2xl border-l-4 border-green-500 p-4 min-w-[300px] transform transition-all duration-300"
        >
          <div class="flex items-center">
            <div class="text-2xl mr-3" id="toastIcon">âœ…</div>
            <div>
              <p class="font-bold text-gray-900" id="toastTitle">ThÃ nh cÃ´ng!</p>
              <p class="text-sm text-gray-600" id="toastMessage">
                ÄÃ£ lÆ°u thay Ä‘á»•i
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Loading -->
      <div id="loading" class="text-center py-12">
        <div class="inline-block bg-white rounded-2xl shadow-lg px-8 py-6">
          <p class="text-xl font-bold text-gray-700">â³ Äang táº£i dá»¯ liá»‡u...</p>
        </div>
      </div>

      <!-- Check-in Lists - 2 Columns -->
      <div id="content" class="hidden">
        <!-- Search Box -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
          <div class="flex items-center gap-3">
            <div class="flex-1">
              <label class="block text-sm font-semibold text-gray-700 mb-2"
                >ğŸ” TÃ¬m kiáº¿m thÃ nh viÃªn</label
              >
              <input
                type="text"
                id="searchInput"
                placeholder="Nháº­p tÃªn hoáº·c Discord nickname..."
                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg font-medium text-gray-700 bg-white hover:border-blue-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
              />
            </div>
            <button
              id="clearSearch"
              class="px-4 py-3 mt-7 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors font-semibold"
              title="XÃ³a tÃ¬m kiáº¿m"
            >
              âœ•
            </button>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- Left Column: Unchecked Section -->
          <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
            <div
              class="bg-gradient-to-r from-orange-500 to-red-500 px-6 py-4 flex items-center justify-between"
            >
              <h2 class="text-xl font-bold text-white flex items-center">
                <span class="text-2xl mr-2">â³</span>
                ChÆ°a check-in (<span id="uncheckedHeader">0</span>)
              </h2>
              <button
                id="copyDiscordNamesBtn"
                class="px-3 py-1.5 bg-white/20 hover:bg-white/30 text-white rounded-lg text-sm font-semibold transition-colors flex items-center gap-2"
                title="Copy Discord names cá»§a táº¥t cáº£ ngÆ°á»i chÆ°a check-in"
              >
                ğŸ“‹ Copy Discord
              </button>
            </div>
            <div
              id="uncheckedList"
              class="divide-y divide-gray-200 max-h-[600px] overflow-y-auto"
            >
              <!-- Will be populated by JavaScript -->
            </div>
          </div>

          <!-- Right Column: Checked Section -->
          <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
            <div
              class="bg-gradient-to-r from-green-500 to-emerald-600 px-6 py-4"
            >
              <h2 class="text-xl font-bold text-white flex items-center">
                <span class="text-2xl mr-2">âœ…</span>
                ÄÃ£ check-in (<span id="checkedHeader">0</span>)
              </h2>
            </div>
            <div
              id="checkedList"
              class="divide-y divide-gray-200 max-h-[600px] overflow-y-auto"
            >
              <!-- Will be populated by JavaScript -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
</Layout>

<script>
  // Import vÃ  khá»Ÿi cháº¡y checkin admin module
  import { initCheckin } from "../../scripts/admin/checkin";
  initCheckin();
</script>

<style>
  @keyframes slideIn {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }

  #toast:not(.hidden) {
    animation: slideIn 0.3s ease-out;
  }

  .checkin-item:focus {
    outline: none;
  }

  /* Focus state - Ä‘Ã£ Ä‘Æ°á»£c xá»­ lÃ½ báº±ng classes trong JavaScript */
  /* Giá»¯ láº¡i style nÃ y Ä‘á»ƒ Ä‘áº£m báº£o khÃ´ng cÃ³ conflict */
  .checkin-item {
    transition: all 0.2s ease-in-out;
  }
</style>
