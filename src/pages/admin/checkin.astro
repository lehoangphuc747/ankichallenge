---
import Layout from '../../layouts/Layout.astro';

// Admin pages ch·ªâ d√πng local, kh√¥ng c·∫ßn build static
export const prerender = false;
---

<Layout title="Admin Check-in - Anki Challenge">
  <main class="min-h-screen bg-gradient-to-br from-green-50 via-blue-50 to-purple-50 py-8 px-4">
    <div class="max-w-7xl mx-auto">
      <!-- Header -->
      <div class="flex items-center justify-between mb-8">
        <div class="flex-1">
          <h1 class="text-4xl font-bold bg-gradient-to-r from-green-600 to-blue-600 bg-clip-text text-transparent mb-2">
            ‚úÖ Qu·∫£n l√Ω Check-in
          </h1>
          <p class="text-gray-600">Click v√†o h√†ng ƒë·ªÉ check/uncheck nhanh</p>
        </div>
        <div class="flex items-center gap-4">
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">Challenge</label>
            <select id="challengeSelect" class="px-4 py-2 border-2 border-blue-300 rounded-lg font-semibold text-gray-700 bg-white hover:border-blue-400 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
              <option value="">ƒêang t·∫£i...</option>
            </select>
          </div>
          <a href="/admin" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors mt-7">
            ‚Üê Dashboard
          </a>
        </div>
      </div>

      <!-- Date Selector & Stats -->
      <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
        <!-- Date Selector -->
        <div class="mb-6">
          <div class="flex items-center justify-center gap-3">
            <button 
              id="prevDay" 
              class="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white rounded-xl shadow-lg hover:shadow-xl transition-all transform hover:scale-105 flex items-center justify-center font-bold text-xl"
              title="Ng√†y tr∆∞·ªõc"
            >
              ‚Üê
            </button>
            <div class="bg-gradient-to-br from-indigo-50 to-blue-50 rounded-xl px-8 py-4 shadow-inner">
              <p class="text-sm text-indigo-600 mb-1 text-center font-bold uppercase tracking-wider" id="dayCounter">DAY ---</p>
              <input 
                type="text" 
                id="selectedDate" 
                class="text-2xl font-bold text-center bg-transparent text-gray-800 outline-none w-36"
                placeholder="dd/mm/yyyy"
                readonly
              />
            </div>
            <button 
              id="nextDay" 
              class="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white rounded-xl shadow-lg hover:shadow-xl transition-all transform hover:scale-105 flex items-center justify-center font-bold text-xl"
              title="Ng√†y sau"
            >
              ‚Üí
            </button>
          </div>
        </div>
        
        <!-- Stats -->
        <div class="grid grid-cols-3 gap-4">
          <div class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-xl p-4 text-center border-2 border-green-200">
            <p class="text-sm text-gray-600 mb-1 font-semibold">‚úÖ ƒê√£ check-in</p>
            <p class="text-3xl font-bold text-green-600" id="checkedCount">0</p>
          </div>
          <div class="bg-gradient-to-br from-orange-50 to-red-50 rounded-xl p-4 text-center border-2 border-orange-200">
            <p class="text-sm text-gray-600 mb-1 font-semibold">‚è≥ Ch∆∞a check-in</p>
            <p class="text-3xl font-bold text-orange-600" id="uncheckedCount">0</p>
          </div>
          <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl p-4 text-center border-2 border-blue-200">
            <p class="text-sm text-gray-600 mb-1 font-semibold">üìä T·ª∑ l·ªá</p>
            <p class="text-3xl font-bold text-blue-600" id="checkinRate">0%</p>
          </div>
        </div>
      </div>

      <!-- Toast Notification -->
      <div id="toast" class="fixed top-4 right-4 z-50 hidden">
        <div class="bg-white rounded-lg shadow-2xl border-l-4 border-green-500 p-4 min-w-[300px] transform transition-all duration-300">
          <div class="flex items-center">
            <div class="text-2xl mr-3" id="toastIcon">‚úÖ</div>
            <div>
              <p class="font-bold text-gray-900" id="toastTitle">Th√†nh c√¥ng!</p>
              <p class="text-sm text-gray-600" id="toastMessage">ƒê√£ l∆∞u thay ƒë·ªïi</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Loading -->
      <div id="loading" class="text-center py-12">
        <div class="inline-block bg-white rounded-2xl shadow-lg px-8 py-6">
          <p class="text-xl font-bold text-gray-700">‚è≥ ƒêang t·∫£i d·ªØ li·ªáu...</p>
        </div>
      </div>

      <!-- Check-in Lists - 2 Columns -->
      <div id="content" class="hidden">
        <!-- Search Box -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
          <div class="flex items-center gap-3">
            <div class="flex-1">
              <label class="block text-sm font-semibold text-gray-700 mb-2">üîç T√¨m ki·∫øm th√†nh vi√™n</label>
              <input 
                type="text" 
                id="searchInput" 
                placeholder="Nh·∫≠p t√™n ho·∫∑c Discord nickname..."
                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg font-medium text-gray-700 bg-white hover:border-blue-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
              />
            </div>
            <button 
              id="clearSearch" 
              class="px-4 py-3 mt-7 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors font-semibold"
              title="X√≥a t√¨m ki·∫øm"
            >
              ‚úï
            </button>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- Left Column: Unchecked Section -->
          <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
            <div class="bg-gradient-to-r from-orange-500 to-red-500 px-6 py-4">
              <h2 class="text-xl font-bold text-white flex items-center">
                <span class="text-2xl mr-2">‚è≥</span>
                Ch∆∞a check-in (<span id="uncheckedHeader">0</span>)
              </h2>
            </div>
            <div id="uncheckedList" class="divide-y divide-gray-200 max-h-[600px] overflow-y-auto">
              <!-- Will be populated by JavaScript -->
            </div>
          </div>

          <!-- Right Column: Checked Section -->
          <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
            <div class="bg-gradient-to-r from-green-500 to-emerald-600 px-6 py-4">
              <h2 class="text-xl font-bold text-white flex items-center">
                <span class="text-2xl mr-2">‚úÖ</span>
                ƒê√£ check-in (<span id="checkedHeader">0</span>)
              </h2>
            </div>
            <div id="checkedList" class="divide-y divide-gray-200 max-h-[600px] overflow-y-auto">
              <!-- Will be populated by JavaScript -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
</Layout>

<script>
  let usersData = null;
  let studyRecordsData = null;
  let currentDate = '';
  let currentChallengeId = 1;
  let challengeDateRanges = {};
  let searchTerm = '';

  // Calculate day number from challenge start
  // Sep 3 = Day 1, Sep 4 = Day 2, Dec 16 = Day 105
  function calculateDayNumber(dateStr) {
    const challengeRange = challengeDateRanges[currentChallengeId];
    if (!challengeRange) return 0;
    
    const start = new Date(challengeRange.start);
    const current = new Date(dateStr);
    
    // Reset time to midnight to avoid timezone issues
    start.setHours(0, 0, 0, 0);
    current.setHours(0, 0, 0, 0);
    
    const diffTime = current.getTime() - start.getTime();
    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
    
    // Day 1 is the start date, so we add 1
    // Example: Sep 3 - Sep 3 = 0 days ‚Üí Day 1
    //          Sep 4 - Sep 3 = 1 day ‚Üí Day 2
    //          Dec 16 - Sep 3 = 104 days ‚Üí Day 105
    return diffDays + 1;
  }

  // Update day counter display
  function updateDayCounter() {
    const dayNumber = calculateDayNumber(currentDate);
    const dayCounterEl = document.getElementById('dayCounter');
    if (dayCounterEl) {
      dayCounterEl.textContent = `DAY ${dayNumber}`;
    }
  }
  let isSaving = false;

  // Format date from YYYY-MM-DD to dd/mm/yyyy
  function formatDate(dateStr) {
    if (!dateStr) return '';
    const [year, month, day] = dateStr.split('-');
    return `${day}/${month}/${year}`;
  }

  // Parse date from dd/mm/yyyy to YYYY-MM-DD
  function parseDate(dateStr) {
    if (!dateStr) return '';
    const [day, month, year] = dateStr.split('/');
    return `${year}-${month}-${day}`;
  }

  // Load data
  async function loadData() {
    console.log('üîÑ [DEBUG] loadData() ƒë∆∞·ª£c g·ªçi!');
    try {
      // Load challenges, users and records
      const [challengesRes, usersRes, recordsRes] = await Promise.all([
        fetch('/api/challenges'),
        fetch('/data/users.json'),
        fetch('/data/studyRecords.json')
      ]);

      const challenges = await challengesRes.json();
      usersData = await usersRes.json();
      studyRecordsData = await recordsRes.json();
      
      // Convert challenges to format expected by rest of code
      challengeDateRanges = {};
      Object.entries(challenges).forEach(([id, data]: [string, any]) => {
        challengeDateRanges[parseInt(id)] = {
          start: data.start,
          end: data.end,
          name: data.name
        };
      });
      console.log('‚úÖ Loaded challenges:', challengeDateRanges);
      
      // Update challenge selector with loaded data
      updateChallengeSelector();
      
      console.log('‚úÖ Data loaded successfully');
    } catch (error) {
      console.error('‚ùå Error loading data:', error);
      showToast('L·ªói!', 'Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu', 'error');
    }
  }

  // Update challenge selector with loaded challenges
  function updateChallengeSelector() {
    const selector = document.getElementById('challengeSelect');
    if (!selector) return;

    selector.innerHTML = Object.entries(challengeDateRanges)
      .map(([id, data]) => `<option value="${id}">${data.name}</option>`)
      .join('');
  }

  // Show toast notification
  function showToast(title, message, type = 'success') {
    const toast = document.getElementById('toast');
    const icon = document.getElementById('toastIcon');
    const titleEl = document.getElementById('toastTitle');
    const messageEl = document.getElementById('toastMessage');
    const toastContainer = toast.querySelector('div');

    if (type === 'success') {
      icon.textContent = '‚úÖ';
      toastContainer.classList.remove('border-red-500', 'border-yellow-500');
      toastContainer.classList.add('border-green-500');
    } else if (type === 'error') {
      icon.textContent = '‚ùå';
      toastContainer.classList.remove('border-green-500', 'border-yellow-500');
      toastContainer.classList.add('border-red-500');
    }

    titleEl.textContent = title;
    messageEl.textContent = message;
    
    toast.classList.remove('hidden');
    
    setTimeout(() => {
      toast.classList.add('hidden');
    }, 3000);
  }

  // Save to server
  async function saveToServer(date, userId, isChecked) {
    if (isSaving) return false;
    isSaving = true;

    try {
      const response = await fetch('/api/checkin', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ date, userId, isChecked })
      });

      if (!response.ok) {
        throw new Error('Failed to save');
      }

      const result = await response.json();
      isSaving = false;
      return result.success;
    } catch (error) {
      console.error('Error saving:', error);
      isSaving = false;
      return false;
    }
  }

  // Toggle check-in
  async function toggleCheckin(userId, userName) {
    console.log('üéØ [DEBUG] toggleCheckin() ƒë∆∞·ª£c g·ªçi cho:', userName, 'userId:', userId);
    // Prevent double-clicking
    if (isSaving) {
      console.log('‚è≥ ƒêang x·ª≠ l√Ω request tr∆∞·ªõc...');
      return;
    }

    const isCurrentlyChecked = studyRecordsData[currentDate]?.[userId.toString()] === true;
    const newState = !isCurrentlyChecked;

    // Optimistic update
    if (!studyRecordsData[currentDate]) {
      studyRecordsData[currentDate] = {};
    }
    
    if (newState) {
      studyRecordsData[currentDate][userId.toString()] = true;
    } else {
      delete studyRecordsData[currentDate][userId.toString()];
    }

    // Update UI immediately (no reload, just re-render)
    console.log('üé® [DEBUG] C·∫≠p nh·∫≠t UI optimistically...');
    renderCheckinList();

    // Save to server in background
    console.log('üíæ [DEBUG] G·ªçi saveToServer...');
    const success = await saveToServer(currentDate, userId, newState);
    console.log('üíæ [DEBUG] saveToServer result:', success);

    if (success) {
      const action = newState ? 'Check-in' : 'X√≥a check-in';
      showToast('ƒê√£ l∆∞u!', `${action} cho ${userName}`, 'success');
    } else {
      // Revert if failed
      if (newState) {
        delete studyRecordsData[currentDate][userId.toString()];
      } else {
        studyRecordsData[currentDate][userId.toString()] = true;
      }
      renderCheckinList();
      showToast('L·ªói!', 'Kh√¥ng th·ªÉ l∆∞u. Vui l√≤ng th·ª≠ l·∫°i', 'error');
    }
  }

  // Render check-in list
  function renderCheckinList() {
    console.log('üñºÔ∏è [DEBUG] renderCheckinList() ƒë∆∞·ª£c g·ªçi cho ng√†y:', currentDate, 'challenge:', currentChallengeId);
    if (!usersData || !studyRecordsData) return;

    // Update day counter
    updateDayCounter();

    // Filter users by current challenge, not hidden, and search term
    const users = usersData.data.filter(u => {
      if (u.hidden) return false;
      if (!u.challengeIds || !u.challengeIds.includes(currentChallengeId)) return false;
      
      // Search filter
      if (searchTerm) {
        const search = searchTerm.toLowerCase();
        const nameMatch = u.name.toLowerCase().includes(search);
        const discordMatch = (u.discordNickname || '').toLowerCase().includes(search);
        return nameMatch || discordMatch;
      }
      
      return true;
    });
    const dateRecords = studyRecordsData[currentDate] || {};

    const checked = [];
    const unchecked = [];

    users.forEach(user => {
      const isChecked = dateRecords[user.id.toString()] === true;
      if (isChecked) {
        checked.push(user);
      } else {
        unchecked.push(user);
      }
    });

    // Update stats
    document.getElementById('checkedCount').textContent = checked.length;
    document.getElementById('uncheckedCount').textContent = unchecked.length;
    document.getElementById('checkedHeader').textContent = checked.length;
    document.getElementById('uncheckedHeader').textContent = unchecked.length;
    
    const rate = users.length > 0 ? Math.round((checked.length / users.length) * 100) : 0;
    document.getElementById('checkinRate').textContent = `${rate}%`;

    // Render unchecked
    const uncheckedList = document.getElementById('uncheckedList');
    uncheckedList.innerHTML = unchecked.length === 0 
      ? '<div class="p-8 text-center text-gray-500">üéâ T·∫•t c·∫£ ƒë√£ check-in!</div>'
      : unchecked.map(user => `
          <div class="checkin-item p-4 hover:bg-orange-50 cursor-pointer transition-colors flex items-center justify-between"
               data-user-id="${user.id}" data-user-name="${user.name.replace(/"/g, '&quot;')}">
            <div class="flex items-center space-x-4">
              <div class="w-12 h-12 rounded-full bg-gradient-to-br from-orange-400 to-red-500 flex items-center justify-center text-white font-bold text-lg">
                ${user.name.charAt(0)}
              </div>
              <div>
                <p class="font-semibold text-gray-900">${user.name}</p>
                <p class="text-sm text-gray-500">${user.discordNickname || 'N/A'}</p>
              </div>
            </div>
            <div class="text-gray-400">
              <span class="text-2xl">‚óã</span>
            </div>
          </div>
        `).join('');

    // Render checked
    const checkedList = document.getElementById('checkedList');
    checkedList.innerHTML = checked.length === 0
      ? '<div class="p-8 text-center text-gray-500">Ch∆∞a c√≥ ai check-in</div>'
      : checked.map(user => `
          <div class="checkin-item p-4 hover:bg-green-50 cursor-pointer transition-colors flex items-center justify-between"
               data-user-id="${user.id}" data-user-name="${user.name.replace(/"/g, '&quot;')}">
            <div class="flex items-center space-x-4">
              <div class="w-12 h-12 rounded-full bg-gradient-to-br from-green-400 to-emerald-500 flex items-center justify-center text-white font-bold text-lg">
                ${user.name.charAt(0)}
              </div>
              <div>
                <p class="font-semibold text-gray-900">${user.name}</p>
                <p class="text-sm text-gray-500">${user.discordNickname || 'N/A'}</p>
              </div>
            </div>
            <div class="text-green-600">
              <span class="text-2xl">‚úì</span>
            </div>
          </div>
        `).join('');
  }

  // Initialize
  async function init() {
    console.log('üöÄ [DEBUG] init() ƒë∆∞·ª£c g·ªçi!');
    // Set today's date
    const today = new Date();
    currentDate = today.toISOString().split('T')[0];
    document.getElementById('selectedDate').value = formatDate(currentDate);

    // Load data
    await loadData();

    // Show content
    document.getElementById('loading').classList.add('hidden');
    document.getElementById('content').classList.remove('hidden');

    // Render
    renderCheckinList();

    // Event delegation for check-in items (prevent any form of page reload)
    document.addEventListener('click', (e) => {
      const item = e.target.closest('.checkin-item');
      if (item) {
        e.preventDefault(); // Prevent any default behavior
        e.stopPropagation(); // Stop event bubbling
        const userId = parseInt(item.dataset.userId);
        const userName = item.dataset.userName;
        
        // Call toggle without waiting (fire and forget for UI responsiveness)
        toggleCheckin(userId, userName);
        return false; // Extra safety to prevent navigation
      }
    });

    // Date change handler (not needed anymore since input is readonly)
    // document.getElementById('selectedDate').addEventListener('change', (e) => {
    //   currentDate = e.target.value;
    //   renderCheckinList();
    // });

    // Previous day button
    document.getElementById('prevDay').addEventListener('click', () => {
      console.log('‚¨ÖÔ∏è [DEBUG] Previous day clicked');
      const date = new Date(currentDate);
      date.setDate(date.getDate() - 1);
      currentDate = date.toISOString().split('T')[0];
      document.getElementById('selectedDate').value = formatDate(currentDate);
      updateDayCounter();
      renderCheckinList();
    });

    // Next day button
    document.getElementById('nextDay').addEventListener('click', () => {
      console.log('‚û°Ô∏è [DEBUG] Next day clicked');
      const date = new Date(currentDate);
      date.setDate(date.getDate() + 1);
      currentDate = date.toISOString().split('T')[0];
      document.getElementById('selectedDate').value = formatDate(currentDate);
      updateDayCounter();
      renderCheckinList();
    });

    // Challenge selector
    document.getElementById('challengeSelect').addEventListener('change', (e) => {
      currentChallengeId = parseInt(e.target.value);
      console.log('üéØ [DEBUG] Challenge changed to:', currentChallengeId);
      updateDayCounter();
      renderCheckinList();
    });

    // Challenge selector
    document.getElementById('challengeSelect').addEventListener('change', (e) => {
      currentChallengeId = parseInt(e.target.value);
      console.log('üéØ [DEBUG] Challenge changed to:', currentChallengeId);
      updateDayCounter();
      renderCheckinList();
    });

    // Search input
    document.getElementById('searchInput').addEventListener('input', (e) => {
      searchTerm = e.target.value.trim();
      console.log('üîç [DEBUG] Searching for:', searchTerm);
      renderCheckinList();
    });

    // Clear search button
    document.getElementById('clearSearch').addEventListener('click', () => {
      searchTerm = '';
      document.getElementById('searchInput').value = '';
      renderCheckinList();
    });
  }

  // Start
  init();
</script>

<style>
  @keyframes slideIn {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }

  #toast:not(.hidden) {
    animation: slideIn 0.3s ease-out;
  }
</style>
