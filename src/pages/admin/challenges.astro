---
import Layout from '../../layouts/Layout.astro';
---

<Layout title="Admin - Quáº£n lÃ½ Challenges">
  <main class="p-8 max-w-7xl mx-auto">
    <div class="flex items-center justify-between mb-8">
      <h1 class="text-4xl font-bold">ğŸ† Quáº£n lÃ½ Challenges</h1>
      <div class="flex gap-3">
        <button id="addChallengeBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
          â• ThÃªm Challenge
        </button>
        <a href="/admin" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors">
          â† Quay láº¡i Dashboard
        </a>
      </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="hidden fixed top-4 right-4 z-50">
      <div class="bg-white rounded-lg shadow-2xl border-l-4 border-green-500 p-4 min-w-[300px]">
        <div class="flex items-center">
          <div class="text-2xl mr-3" id="toastIcon">âœ…</div>
          <div>
            <p class="font-bold text-gray-900" id="toastTitle">ThÃ nh cÃ´ng!</p>
            <p class="text-sm text-gray-600" id="toastMessage">ÄÃ£ lÆ°u thay Ä‘á»•i</p>
          </div>
        </div>
      </div>
    </div>
    
    <div id="loading" class="text-center py-8">
      <p class="text-gray-500 text-lg">Äang táº£i dá»¯ liá»‡u...</p>
    </div>
    
    <!-- Challenges List -->
    <div id="challengesList" class="hidden space-y-6">
    </div>

    <!-- Add/Edit Challenge Modal -->
    <div id="challengeModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded-lg p-8 max-w-2xl w-full mx-4">
        <h2 class="text-2xl font-bold mb-6" id="modalTitle">ThÃªm Challenge</h2>
        <form id="challengeForm" class="space-y-4">
          <input type="hidden" id="editId" />
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">TÃªn Challenge *</label>
            <input type="text" id="challengeName" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Anki Challenge 11" />
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">NgÃ y báº¯t Ä‘áº§u *</label>
              <input type="date" id="startDate" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">NgÃ y káº¿t thÃºc *</label>
              <input type="date" id="endDate" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" />
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">MÃ´ táº£</label>
            <textarea id="description" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="100 ngÃ y thá»­ thÃ¡ch"></textarea>
          </div>

          <div class="flex gap-3 justify-end pt-4">
            <button type="button" id="cancelModal" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">
              Há»§y
            </button>
            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
              LÆ°u
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Manage Members Modal -->
    <div id="membersModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded-lg p-8 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <h2 class="text-2xl font-bold mb-6">Quáº£n lÃ½ thÃ nh viÃªn - <span id="currentChallengeName"></span></h2>
        
        <div class="mb-6">
          <h3 class="text-lg font-semibold mb-3">ThÃ nh viÃªn hiá»‡n táº¡i (<span id="currentMembersCount">0</span>)</h3>
          <div id="currentMembersList" class="space-y-2 max-h-60 overflow-y-auto">
          </div>
        </div>

        <div>
          <h3 class="text-lg font-semibold mb-3">ThÃªm thÃ nh viÃªn</h3>
          <div id="availableMembersList" class="space-y-2 max-h-60 overflow-y-auto">
          </div>
        </div>

        <div class="flex justify-end mt-6">
          <button type="button" id="closeMembersModal" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors">
            ÄÃ³ng
          </button>
        </div>
      </div>
    </div>

  </main>
</Layout>

<script>
  let challengesData = {};
  let usersData = [];
  let currentEditingChallengeId = null;

  // Challenge date ranges - ID mapping: 1=Challenge 8, 2=Challenge 9, 3=Challenge 10
  const defaultChallenges = {
    '1': { name: 'Anki Challenge 8', start: '2025-09-03', end: '2025-12-21', description: '100 ngÃ y + 10 ngÃ y gia háº¡n' },
    '2': { name: 'Anki Challenge 9', start: '2025-12-22', end: '2026-03-31', description: '100 ngÃ y thá»­ thÃ¡ch' },
    '3': { name: 'Anki Challenge 10', start: '2026-05-01', end: '2026-08-09', description: '100 ngÃ y thá»­ thÃ¡ch' }
  };

  async function loadData() {
    try {
      // Load users and challenges (thÃªm cache-busting)
      const cb = '?v=' + Date.now();
      const [usersResponse, challengesResponse] = await Promise.all([
        fetch('/data/users.json' + cb),
        fetch('/api/challenges' + cb)
      ]);
      
      const usersDataJson = await usersResponse.json();
      usersData = usersDataJson.data || [];
      
      challengesData = await challengesResponse.json();

      renderChallenges();
      document.getElementById('loading')?.classList.add('hidden');
      document.getElementById('challengesList')?.classList.remove('hidden');

    } catch (error) {
      console.error('Error loading data:', error);
      showToast('Lá»—i!', 'KhÃ´ng thá»ƒ táº£i dá»¯ liá»‡u', 'error');
    }
  }

  function renderChallenges() {
    const listEl = document.getElementById('challengesList');
    if (!listEl) return;

    const html = Object.entries(challengesData).map(([id, challenge]) => {
      const membersCount = usersData.filter(u => u.challengeIds && u.challengeIds.includes(parseInt(id))).length;
      
      return `
        <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-blue-500">
          <div class="flex items-center justify-between">
            <div class="flex-1">
              <h3 class="text-2xl font-bold text-gray-900 mb-2">${challenge.name}</h3>
              <p class="text-gray-600 mb-3">${challenge.description || ''}</p>
              <div class="flex gap-4 text-sm text-gray-600">
                <span>ğŸ“… ${challenge.start} - ${challenge.end}</span>
                <span>ğŸ‘¥ ${membersCount} thÃ nh viÃªn</span>
              </div>
            </div>
            <div class="flex gap-2">
              <button class="manage-members-btn px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm" data-id="${id}">
                ğŸ‘¥ Quáº£n lÃ½ thÃ nh viÃªn
              </button>
              <button class="edit-challenge-btn px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm" data-id="${id}">
                âœï¸ Sá»­a
              </button>
              <button class="delete-challenge-btn px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors text-sm" data-id="${id}">
                ğŸ—‘ï¸ XÃ³a
              </button>
            </div>
          </div>
        </div>
      `;
    }).join('');

    listEl.innerHTML = html || '<p class="text-gray-500 text-center py-8">ChÆ°a cÃ³ challenge nÃ o</p>';

    // Add event listeners
    document.querySelectorAll('.edit-challenge-btn').forEach(btn => {
      btn.addEventListener('click', () => editChallenge(btn.dataset.id));
    });

    document.querySelectorAll('.delete-challenge-btn').forEach(btn => {
      btn.addEventListener('click', () => deleteChallenge(btn.dataset.id));
    });

    document.querySelectorAll('.manage-members-btn').forEach(btn => {
      btn.addEventListener('click', () => openMembersModal(btn.dataset.id));
    });
  }

  function editChallenge(id) {
    const challenge = challengesData[id];
    if (!challenge) return;

    currentEditingChallengeId = id;
    document.getElementById('modalTitle')!.textContent = 'Chá»‰nh sá»­a Challenge';
    document.getElementById('editId')!.value = id;
    document.getElementById('challengeName')!.value = challenge.name;
    document.getElementById('startDate')!.value = challenge.start;
    document.getElementById('endDate')!.value = challenge.end;
    document.getElementById('description')!.value = challenge.description || '';
    
    document.getElementById('challengeModal')?.classList.remove('hidden');
  }

  async function deleteChallenge(id) {
    if (!confirm('Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a challenge nÃ y? ThÃ nh viÃªn sáº½ khÃ´ng bá»‹ xÃ³a.')) return;

    try {
      delete challengesData[id];
      
      const response = await fetch('/api/challenges', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(challengesData)
      });

      const result = await response.json();
      if (!result.success) throw new Error('Failed to delete');
      
      showToast('ÄÃ£ xÃ³a!', 'Challenge Ä‘Ã£ Ä‘Æ°á»£c xÃ³a', 'success');
      renderChallenges();
    } catch (error) {
      console.error('Error deleting challenge:', error);
      showToast('Lá»—i!', 'KhÃ´ng thá»ƒ xÃ³a challenge', 'error');
    }
  }

  function openMembersModal(challengeId) {
    currentEditingChallengeId = challengeId;
    const challenge = challengesData[challengeId];
    
    document.getElementById('currentChallengeName')!.textContent = challenge.name;
    
    const currentMembers = usersData.filter(u => u.challengeIds && u.challengeIds.includes(parseInt(challengeId)));
    const availableMembers = usersData.filter(u => !u.challengeIds || !u.challengeIds.includes(parseInt(challengeId)));
    
    document.getElementById('currentMembersCount')!.textContent = currentMembers.length.toString();
    
    // Render current members
    document.getElementById('currentMembersList')!.innerHTML = currentMembers.length === 0
      ? '<p class="text-gray-500 text-sm">ChÆ°a cÃ³ thÃ nh viÃªn nÃ o</p>'
      : currentMembers.map(m => `
          <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg">
            <span class="font-medium">${m.name}</span>
            <button class="remove-member-btn px-3 py-1 bg-red-500 text-white rounded text-sm hover:bg-red-600" data-user-id="${m.id}">
              XÃ³a
            </button>
          </div>
        `).join('');
    
    // Render available members
    document.getElementById('availableMembersList')!.innerHTML = availableMembers.length === 0
      ? '<p class="text-gray-500 text-sm">KhÃ´ng cÃ³ thÃ nh viÃªn kháº£ dá»¥ng</p>'
      : availableMembers.map(m => `
          <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
            <span class="font-medium">${m.name}</span>
            <button class="add-member-btn px-3 py-1 bg-blue-500 text-white rounded text-sm hover:bg-blue-600" data-user-id="${m.id}">
              ThÃªm
            </button>
          </div>
        `).join('');
    
    // Add event listeners
    document.querySelectorAll('.remove-member-btn').forEach(btn => {
      btn.addEventListener('click', () => removeMemberFromChallenge(parseInt(btn.dataset.userId!)));
    });
    
    document.querySelectorAll('.add-member-btn').forEach(btn => {
      btn.addEventListener('click', () => addMemberToChallenge(parseInt(btn.dataset.userId!)));
    });
    
    document.getElementById('membersModal')?.classList.remove('hidden');
  }

  async function addMemberToChallenge(userId) {
    try {
      const user = usersData.find(u => u.id === userId);
      if (!user) return;
      
      if (!user.challengeIds) user.challengeIds = [];
      user.challengeIds.push(parseInt(currentEditingChallengeId!));
      
      const response = await fetch('/api/update-users', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ data: usersData })
      });

      const result = await response.json();
      if (!result.success) throw new Error('Failed to add member');
      
      showToast('ÄÃ£ thÃªm!', `${user.name} Ä‘Ã£ Ä‘Æ°á»£c thÃªm vÃ o challenge`, 'success');
      openMembersModal(currentEditingChallengeId!);
      renderChallenges();
    } catch (error) {
      console.error('Error adding member:', error);
      showToast('Lá»—i!', 'KhÃ´ng thá»ƒ thÃªm thÃ nh viÃªn', 'error');
    }
  }

  async function removeMemberFromChallenge(userId) {
    try {
      const user = usersData.find(u => u.id === userId);
      if (!user) return;
      
      user.challengeIds = (user.challengeIds || []).filter(id => id !== parseInt(currentEditingChallengeId!));
      
      const response = await fetch('/api/update-users', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ data: usersData })
      });

      const result = await response.json();
      if (!result.success) throw new Error('Failed to remove member');
      
      showToast('ÄÃ£ xÃ³a!', `${user.name} Ä‘Ã£ Ä‘Æ°á»£c xÃ³a khá»i challenge`, 'success');
      openMembersModal(currentEditingChallengeId!);
      renderChallenges();
    } catch (error) {
      console.error('Error removing member:', error);
      showToast('Lá»—i!', 'KhÃ´ng thá»ƒ xÃ³a thÃ nh viÃªn', 'error');
    }
  }

  function showToast(title, message, type = 'success') {
    const toast = document.getElementById('toast');
    const icon = document.getElementById('toastIcon');
    const titleEl = document.getElementById('toastTitle');
    const messageEl = document.getElementById('toastMessage');

    if (type === 'success') {
      icon!.textContent = 'âœ…';
    } else if (type === 'error') {
      icon!.textContent = 'âŒ';
    }

    titleEl!.textContent = title;
    messageEl!.textContent = message;
    
    toast?.classList.remove('hidden');
    
    setTimeout(() => {
      toast?.classList.add('hidden');
    }, 3000);
  }

  // Event listeners
  document.getElementById('addChallengeBtn')?.addEventListener('click', () => {
    currentEditingChallengeId = null;
    document.getElementById('modalTitle')!.textContent = 'ThÃªm Challenge';
    document.getElementById('challengeForm')!.reset();
    document.getElementById('challengeModal')?.classList.remove('hidden');
  });

  document.getElementById('cancelModal')?.addEventListener('click', () => {
    document.getElementById('challengeModal')?.classList.add('hidden');
  });

  document.getElementById('closeMembersModal')?.addEventListener('click', () => {
    document.getElementById('membersModal')?.classList.add('hidden');
  });

  document.getElementById('challengeForm')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const name = (document.getElementById('challengeName') as HTMLInputElement).value;
    const start = (document.getElementById('startDate') as HTMLInputElement).value;
    const end = (document.getElementById('endDate') as HTMLInputElement).value;
    const description = (document.getElementById('description') as HTMLTextAreaElement).value;
    
    try {
      if (currentEditingChallengeId) {
        // Edit existing
        challengesData[currentEditingChallengeId] = { name, start, end, description };
      } else {
        // Add new
        const newId = (Math.max(...Object.keys(challengesData).map(k => parseInt(k))) + 1).toString();
        challengesData[newId] = { name, start, end, description };
      }
      
      const response = await fetch('/api/challenges', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(challengesData)
      });

      const result = await response.json();
      if (!result.success) throw new Error('Failed to save');
      
      showToast('ÄÃ£ lÆ°u!', 'Challenge Ä‘Ã£ Ä‘Æ°á»£c lÆ°u', 'success');
      document.getElementById('challengeModal')?.classList.add('hidden');
      renderChallenges();
    } catch (error) {
      console.error('Error saving challenge:', error);
      showToast('Lá»—i!', 'KhÃ´ng thá»ƒ lÆ°u challenge', 'error');
    }
  });

  // Load data on page load
  loadData();
</script>

<style>
  @keyframes slideIn {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }

  #toast:not(.hidden) {
    animation: slideIn 0.3s ease-out;
  }
</style>
