---
import Layout from "../../layouts/Layout.astro";
---

<Layout title="Admin Dashboard - Anki Challenge">
  <main class="min-h-screen bg-gray-50/50 py-10 px-6">
    <div class="max-w-5xl mx-auto space-y-10">
      <!-- Header -->
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-3xl font-extrabold text-gray-900 tracking-tight">
            Admin Dashboard
          </h1>
          <p class="text-gray-500 font-medium">Ch√†o m·ª´ng tr·ªü l·∫°i! üëã</p>
        </div>
        <div class="text-right hidden sm:block">
          <p class="text-sm text-gray-400 font-mono" id="lastUpdate">
            Updating...
          </p>
        </div>
      </div>

      <!-- Quick Stats Row (Compact) -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div
          class="bg-white rounded-2xl p-5 shadow-sm border border-gray-100 flex flex-col justify-between h-32 hover:border-purple-200 transition-colors"
        >
          <div
            class="text-gray-400 text-sm font-semibold uppercase tracking-wider"
          >
            Th√†nh vi√™n
          </div>
          <div class="flex items-end justify-between">
            <span class="text-4xl font-black text-gray-900" id="totalMembers"
              >--</span
            >
            <span class="text-2xl opacity-20">üë•</span>
          </div>
        </div>

        <div
          class="bg-white rounded-2xl p-5 shadow-sm border border-gray-100 flex flex-col justify-between h-32 hover:border-pink-200 transition-colors"
        >
          <div
            class="text-gray-400 text-sm font-semibold uppercase tracking-wider"
          >
            Ho·∫°t ƒë·ªông
          </div>
          <div class="flex items-end justify-between">
            <span class="text-4xl font-black text-gray-900" id="activeMembers"
              >--</span
            >
            <span class="text-2xl opacity-20">üî•</span>
          </div>
        </div>

        <div
          class="bg-white rounded-2xl p-5 shadow-sm border border-gray-100 flex flex-col justify-between h-32 hover:border-blue-200 transition-colors"
        >
          <div
            class="text-gray-400 text-sm font-semibold uppercase tracking-wider"
          >
            Check-in
          </div>
          <div class="flex items-end justify-between">
            <span class="text-4xl font-black text-gray-900" id="todayCheckins"
              >--</span
            >
            <span class="text-2xl opacity-20">‚úÖ</span>
          </div>
        </div>

        <div
          class="bg-white rounded-2xl p-5 shadow-sm border border-gray-100 flex flex-col justify-between h-32 hover:border-green-200 transition-colors"
        >
          <div
            class="text-gray-400 text-sm font-semibold uppercase tracking-wider"
          >
            Ng√†y c√≤n l·∫°i
          </div>
          <div class="flex items-end justify-between">
            <span class="text-4xl font-black text-gray-900" id="daysLeft"
              >--</span
            >
            <span class="text-2xl opacity-20">‚è≥</span>
          </div>
        </div>
      </div>

      <!-- Main Navigation (Focused Grid) -->
      <div>
        <h2 class="text-lg font-bold text-gray-800 mb-4 px-1">Menu Qu·∫£n L√Ω</h2>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
          <!-- Check-in (Most Used - Highlighted) -->
          <a
            href="/admin/checkin"
            class="group relative overflow-hidden bg-white rounded-3xl p-8 shadow-sm border border-gray-100 hover:shadow-xl hover:border-pink-300 transition-all duration-300 flex flex-col items-center text-center"
          >
            <div
              class="absolute inset-0 bg-gradient-to-br from-pink-50 to-purple-50 opacity-0 group-hover:opacity-100 transition-opacity"
            >
            </div>
            <div
              class="relative z-10 w-20 h-20 bg-pink-100 text-pink-600 rounded-full flex items-center justify-center text-4xl mb-6 shadow-inner group-hover:scale-110 transition-transform duration-300"
            >
              ‚úÖ
            </div>
            <h3
              class="relative z-10 text-xl font-bold text-gray-900 group-hover:text-pink-700 transition-colors"
            >
              Check-in
            </h3>
            <p class="relative z-10 text-sm text-gray-500 mt-2 font-medium">
              Qu·∫£n l√Ω ƒëi·ªÉm danh h√†ng ng√†y
            </p>
          </a>

          <!-- Members -->
          <a
            href="/admin/members"
            class="group relative overflow-hidden bg-white rounded-3xl p-8 shadow-sm border border-gray-100 hover:shadow-xl hover:border-purple-300 transition-all duration-300 flex flex-col items-center text-center"
          >
            <div
              class="absolute inset-0 bg-gradient-to-br from-purple-50 to-indigo-50 opacity-0 group-hover:opacity-100 transition-opacity"
            >
            </div>
            <div
              class="relative z-10 w-20 h-20 bg-purple-100 text-purple-600 rounded-full flex items-center justify-center text-4xl mb-6 shadow-inner group-hover:scale-110 transition-transform duration-300"
            >
              üë•
            </div>
            <h3
              class="relative z-10 text-xl font-bold text-gray-900 group-hover:text-purple-700 transition-colors"
            >
              Th√†nh vi√™n
            </h3>
            <p class="relative z-10 text-sm text-gray-500 mt-2 font-medium">
              Danh s√°ch & th√¥ng tin ng∆∞·ªùi ch∆°i
            </p>
          </a>

          <!-- Challenges & Config -->
          <a
            href="/admin/challenges"
            class="group relative overflow-hidden bg-white rounded-3xl p-8 shadow-sm border border-gray-100 hover:shadow-xl hover:border-blue-300 transition-all duration-300 flex flex-col items-center text-center"
          >
            <div
              class="absolute inset-0 bg-gradient-to-br from-blue-50 to-cyan-50 opacity-0 group-hover:opacity-100 transition-opacity"
            >
            </div>
            <div
              class="relative z-10 w-20 h-20 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-4xl mb-6 shadow-inner group-hover:scale-110 transition-transform duration-300"
            >
              ‚öôÔ∏è
            </div>
            <h3
              class="relative z-10 text-xl font-bold text-gray-900 group-hover:text-blue-700 transition-colors"
            >
              C·∫•u h√¨nh
            </h3>
            <p class="relative z-10 text-sm text-gray-500 mt-2 font-medium">
              Challenge & C√†i ƒë·∫∑t h·ªá th·ªëng
            </p>
          </a>
        </div>
      </div>

      <!-- Public Link -->
      <div class="text-center pt-8 border-t border-gray-200 border-dashed">
        <a
          href="/"
          class="inline-flex items-center gap-2 text-gray-500 hover:text-indigo-600 font-semibold transition-colors px-4 py-2 rounded-lg hover:bg-white"
        >
          <span>üèÜ</span> Xem B·∫£ng X·∫øp H·∫°ng C√¥ng Khai
        </a>
      </div>
    </div>
  </main>
</Layout>

<script>
  // Load and display stats
  async function loadStats() {
    try {
      // Load metadata tr∆∞·ªõc ƒë·ªÉ l·∫•y lastUpdated l√†m cache-buster
      // ƒê·∫£m b·∫£o lu√¥n l·∫•y d·ªØ li·ªáu m·ªõi nh·∫•t t·ª´ server
      const metadataResponse = await fetch(
        "/data/metadata.json?v=" + Date.now(),
      );
      const metadata = await metadataResponse.json();
      const cacheBuster = metadata?.lastUpdated
        ? "?v=" + new Date(metadata.lastUpdated).getTime()
        : "?v=" + Date.now();

      const [usersResponse, studyRecordsResponse] = await Promise.all([
        fetch("/data/users.json" + cacheBuster),
        fetch("/data/studyRecords.json" + cacheBuster),
      ]);

      const usersData = await usersResponse.json();
      const studyRecordsData = await studyRecordsResponse.json();

      // Total members
      const totalMembers = usersData.data?.length || 0;
      const activeMembers =
        usersData.data?.filter((u) => !u.hidden).length || 0;

      // Today's check-ins
      const today = new Date().toISOString().split("T")[0];
      const todayRecords = studyRecordsData[today] || {};
      const todayCheckins = Object.keys(todayRecords).length;

      // Days left in challenge
      const endDate = new Date("2025-12-21");
      const currentDate = new Date();
      const daysLeft = Math.max(
        0,
        Math.ceil(
          (endDate.getTime() - currentDate.getTime()) / (1000 * 60 * 60 * 24),
        ),
      );

      // Update UI
      document.getElementById("totalMembers")!.textContent =
        totalMembers.toString();
      document.getElementById("activeMembers")!.textContent =
        activeMembers.toString();
      document.getElementById("todayCheckins")!.textContent =
        todayCheckins.toString();
      document.getElementById("daysLeft")!.textContent = daysLeft.toString();

      // Last update
      if (metadata.lastUpdated) {
        const lastUpdateDate = new Date(metadata.lastUpdated);
        document.getElementById("lastUpdate")!.textContent =
          lastUpdateDate.toLocaleString("vi-VN");
      }
    } catch (error) {
      console.error("Error loading stats:", error);
    }
  }

  // Load stats on page load
  loadStats();
</script>

<style>
  @keyframes gradient {
    0% {
      background-position: 0% 50%;
    }
    50% {
      background-position: 100% 50%;
    }
    100% {
      background-position: 0% 50%;
    }
  }

  .aurora-button {
    background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
    background-size: 200% 200%;
    animation: gradient 3s ease infinite;
  }
</style>
